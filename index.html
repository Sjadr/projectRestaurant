<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>نظام تسجيل الحضور</title>
  <style>
    #adminPanel {
      box-shadow: 0 2px 12px rgba(151, 86, 86, 0.067);
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      direction: rtl;
      background-color: #f4f4f4;
      margin: 0; padding: 0;
    }
    .container {
      max-width: 700px;
      margin: auto;
      padding: 20px;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin-top: 30px;
    }
    h2 { text-align: center; color: #333; }
    input, button, select {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 16px;
      box-sizing: border-box;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover { background-color: #0056b3; }
    button:active { background-color: #1976d2; }
    #mainContent, #adminPanel { display: none; }
    #attendanceTable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    #attendanceTable th {
      border: 1px solid #000000;
      padding: 10px 8px;
      text-align: center;
      background: #000000;
      color: #fff;
      font-weight: 700;
      font-size: 18px;
      letter-spacing: 0.5px;
      border-bottom: 2.5px solid #000000;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      transition: background 0.2s;
      box-shadow: 0 2px 8px #e3eafc;
    }
    @media (max-width: 767px) {
      #attendanceTable th {
        font-size: 15px;
        padding: 7px 4px;
        border-top-left-radius: 4px;
        border-top-right-radius: 4px;
      }
    }
    #attendanceTable td {
      border: 1px solid #ccc;
      padding: 5px;
      text-align: center;
    }
    .editor-tag { font-size: 12px; color: #555; }
    .error { color: red; text-align: center; margin: 10px 0; }
    .loading { text-align: center; color: #666; margin: 10px 0; }
    #adminPanel { margin-top: 20px; border-top: 1px solid #ccc; padding-top: 10px; }
    #adminPanel h3 { margin-top: 0; text-align: center; }
    table#usersTable, table#employeesTable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    table#usersTable th, table#usersTable td,
    table#employeesTable th, table#employeesTable td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    .small-button {
      padding: 5px 10px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 3px;
    }
    .btn-edit { background-color: #28a745; color: white; border: none; }
    .btn-delete { background-color: #dc3545; color: white; border: none; }
    .btn-toggle { background-color: #ffc107; color: black; border: none; }
    @media (max-width: 767px) {
      .container { padding: 10px; }
      input, button, select { font-size: 14px; padding: 8px; }
      #attendanceTable th, #attendanceTable td { font-size: 18px; padding: 3px; }
    }
    .tooltip-wrapper { position: relative; display: inline-block; cursor: help; }
    .tooltip-wrapper .tooltip-text {
      visibility: hidden;
      width: 200px;
      background-color: #361fa7;
      color: #fff;
      text-align: right;
      padding: 8px;
      border-radius: 6px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      right: 50%;
      transform: translateX(50%);
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
      line-height: 1.4;
    }
    .tooltip-wrapper.show .tooltip-text { visibility: visible; opacity: 1; }
    .checkbox-label {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      margin-top: 5px;
    }
    .checkbox-label input[type="checkbox"] {
      transform: none;
      vertical-align: middle;
      margin: 0;
    }
    #sidebarMenu {
      position: fixed;
      top: 0;
      right: 0;
      width: 0;
      height: 100vh;
      background: #fff;
      box-shadow: -2px 0 12px #0002;
      overflow-x: hidden;
      transition: 0.3s;
      z-index: 5000;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding-top: 0;
    }
    #sidebarMenu.open {
      width: 210px;
      padding-top: 30px;
    }
    #sidebarMenu .sidebar-header {
      width: 100%;
      padding: 14px 18px 8px 18px;
      background: #007bff;
      color: #fff;
      font-size: 16px;
      font-weight: bold;
      text-align: right;
      border-bottom: 1px solid #eee;
      letter-spacing: 0.5px;
    }
    #sidebarMenu button {
      width: 88%;
      margin: 8px 6%;
      padding: 8px;
      font-size: 15px;
      border-radius: 6px;
      border: none;
      background: #f4f4f4;
      color: #333;
      cursor: pointer;
      text-align: right;
      transition: background 0.2s;
    }
    #sidebarMenu button:hover {
      background: #e0e0e0;
    }
    #sidebarToggleBtn, #sidebarCloseBtn {
      position: fixed;
      top: 14px;
      right: 14px;
      width: 34px;
      height: 34px;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      z-index: 5100;
      box-shadow: 0 2px 8px #0002;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    #sidebarCloseBtn {
      background: rgba(0,0,0,0.08);
      color: #333;
      font-size: 18px;
      border: none;
      box-shadow: none;
      width: 30px;
      height: 30px;
      right: 18px;
      top: 18px;
      opacity: 0.7;
    }
    #sidebarCloseBtn:hover {
      background: #f4f4f4;
      opacity: 1;
    }
    @media (max-width: 600px) {
      #sidebarMenu.open { width: 90vw; }
      #sidebarToggleBtn, #sidebarCloseBtn { right: 8px; top: 8px; }
    }
  </style>
</head>
<body>
<div class="container">

  <!-- تسجيل الدخول -->
  <div id="loginBox">
    <h2>تسجيل الدخول</h2>
    <input type="text" id="username" placeholder="اسم المستخدم" autocomplete="off" />
    <input type="password" id="password" placeholder="كلمة المرور" autocomplete="off" />
    <button onclick="login()">دخول</button>
    <div id="loginMessage"></div>
    <div style="text-align:center; margin-top:10px; font-size:14px; color:#555; font-style:italic; line-height:1.3;">
      بتصميم المهندس سجاد رشيد<br />
      insta: e ._ mg
    </div>
  </div>

  <!-- المحتوى الرئيسي وجدول الحضور -->
  <div id="mainContent">
    <h2>📋 جدول الحضور - تموز</h2>
    <button id="btnDownloadPDF" style="margin-bottom:10px;" onclick="downloadPDF()">⬇️ تحميل PDF</button>
    <table id="attendanceTable">
      <thead>
        <tr>
          <th style="background: linear-gradient(90deg, #e3f0ff 0%, #cbe6ff 100%); color: #1976d2; font-weight: bold; font-size: 18px; border-bottom: 2.5px solid #90caf9; letter-spacing: 0.5px;">التاريخ</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
    <button onclick="saveData()">💾 حفظ التعديلات</button>
    <button onclick="logout()" style="background-color: #dc3545; margin-top: 10px;">🚪 تسجيل خروج</button>
    <h3 style="margin-top:20px;">📊 الإحصائيات</h3>
    <div id="statsBox">—</div>
  </div>

  <!-- لوحة تحكم الـ Admin -->
  <div id="adminPanel" style="display:none">
    <h3>لوحة تحكم المدير</h3>
    <h4>إدارة الموظفين</h4>
    <input type="text" id="newEmployeeName" placeholder="اسم الموظف الجديد" />
    <button onclick="addEmployee()">➕ إضافة موظف</button>
    <table id="employeesTable">
      <thead>
        <tr><th>اسم الموظف</th><th>حذف</th></tr>
      </thead>
      <tbody id="employeesBody"></tbody>
    </table>
    <hr />
    <h4>إدارة المستخدمين</h4>
    <input type="text" id="newUserName" placeholder="اسم المستخدم الجديد" />
    <input type="password" id="newUserPass" placeholder="كلمة المرور" />
    <label class="checkbox-label">
      <input type="checkbox" id="newUserCanEdit" checked />صلاحية تعديل الجدول
    </label>
    <button onclick="addUser()">➕ إنشاء مستخدم</button>
    <table id="usersTable">
      <thead>
        <tr>
          <th>اسم المستخدم</th>
          <th>الصلاحية (تعديل؟)</th>
          <th>تغيير الصلاحية</th>
          <th>حذف المستخدم</th>
          <th>تسجيل خروج إجباري</th>
        </tr>
      </thead>
      <tbody id="usersBody"></tbody>
    </table>
    <button id="toggleEmpStatsBtn" style="background:#17a2b8;color:white;font-size:13px;padding:7px 12px;margin-bottom:10px;cursor:pointer;">
      📊 تفاصيل إحصائيات الموظفين
    </button>
    <div id="empStatsTab" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.45);z-index:2000;align-items:center;justify-content:center;">
      <div style="background:#fff;max-width:500px;width:95vw;max-height:90vh;overflow:auto;border-radius:12px;box-shadow:0 8px 32px #0002;padding:25px 20px 20px 20px;position:relative;">
        <button id="closeEmpStatsTab" style="position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;">✖</button>
        <h3 style="text-align:center;margin-bottom:18px;">📊 إحصائيات الموظفين</h3>
        <div id="empStatsTabContent"></div>
      </div>
    </div>
    <button id="btnDeleteData" style="background-color:#dc3545; color:white; font-size:12px; padding:5px 10px; margin-top:15px; cursor:pointer;">
      🗑️ حذف بيانات متقدمة
    </button>
    <!-- أضف زر الميزات المتقدمة بعد زر حذف البيانات المتقدمة في لوحة التحكم -->
    <button id="btnFeaturesTab" style="background:#673ab7;color:white;font-size:13px;padding:7px 12px;margin-bottom:10px;cursor:pointer;">
      ⭐️سجل النشاطات
    </button>
    <div id="featuresTab" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.45);z-index:3000;align-items:center;justify-content:center;">
      <div style="background:#fff;max-width:520px;width:97vw;max-height:92vh;overflow:auto;border-radius:14px;box-shadow:0 8px 32px #0002;padding:25px 18px 18px 18px;position:relative;">
        <button id="closeFeaturesTab" style="position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;">✖</button>
        <h3 style="text-align:center;margin-bottom:18px;color:#673ab7;">⭐️ تفاصيل السجلات</h3>
        <div id="featuresTabContent"></div>
      </div>
    </div>
    <style>
      @media (max-width: 600px) {
        #featuresTab > div {
          max-width: 99vw !important;
          padding: 10px 2vw 10px 2vw !important;
        }
        #featuresTab h3 { font-size: 18px !important; }
      }
      .feature-section {
        background: #f6f8fa;
        border-radius: 10px;
        margin-bottom: 18px;
        padding: 13px 12px;
        box-shadow: 0 1px 6px #0001;
      }
      .feature-section h4 {
        margin: 0 0 7px 0;
        color: #3f51b5;
        font-size: 16px;
      }
      .activity-log-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 7px;
        font-size: 14px;
      }
      .activity-log-table th, .activity-log-table td {
        border: 1px solid #ccc;
        padding: 5px 4px;
        text-align: center;
      }
      .activity-log-table th {
        background: #ede7f6;
        color: #673ab7;
      }
    </style>
  </div>
</div>

<!-- تم حذف الأنماط المكررة للـ sidebarMenu لتقليل التكرار -->
<button id="sidebarToggleBtn" style="display:none;">☰</button>
<button id="sidebarCloseBtn" style="display:none;">✖</button>
<div id="sidebarMenu">
  <div class="sidebar-header" id="sidebarUserName"></div>
  <button onclick="downloadPDF()" style="background:#0dc149;color:rgb(255, 255, 255);">⬇️ تحميل PDF</button>
  <button onclick="saveData()" style="background:#2196f3;color:white;"> 💾 حفظ التعديلات</button>
  <button onclick="logout()" style="background:#dc3545;color:white;">🚪 تسجيل خروج</button>
  <button id="sidebarAdminBtn" style="background:#000000;color:white;display:none;">⚙️ لوحة التحكم</button>
  <button id="sidebarEmpStatsBtn" style="background:#17a2b8;color:white;display:none;">📊 تفاصيل إحصائيات الموظفين</button>
  <button id="sidebarDeleteDataBtn" style="background:#dc3545;color:white;display:none;">🗑️ حذف بيانات متقدمة</button>
  <button id="sidebarFeaturesTabBtn" style="background:#673ab7;color:white;display:none;">⭐️سجل النشاطات</button>
  <button id="sidebarChangePassBtn" style="background:#2196f3;color:white;">🔑 تغيير كلمة المرور</button>
  <!-- أضف زر التحكم في صلاحيات سجل النشاطات للمدير في القائمة الجانبية -->
  <button id="sidebarUserControlBtn" style="background:#009688;color:white;display:none;">👥 صلاحيات سجل النشاطات</button>
  <!-- زر الملاحظات -->
  <button id="sidebarNotesBtn" style="background:#ffb300;color:#333;display:none;">📝 الملاحظات</button>
  <!-- زر إعدادات الملاحظات للمدير فقط -->
  <button id="sidebarNotesSettingsBtn" style="background:#ff9800;color:#222;display:none;">⚙️ إعدادات الملاحظات</button>
</div>
<script>
  // زر إعدادات الملاحظات (للمدير فقط)
document.getElementById("sidebarNotesSettingsBtn").onclick = function() {
  document.getElementById("sidebarMenu").classList.remove("open");
  setTimeout(showNotesSettingsTab, 100);
};

  // نافذة إعدادات الملاحظات
  function showNotesSettingsTab() {
    let modal = document.getElementById("notesSettingsModal");
    if (!modal) {
      modal = document.createElement("div");
      modal.id = "notesSettingsModal";
      modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:8000;display:flex;align-items:center;justify-content:center;`;
      modal.innerHTML = `
        <div style=\"background:#fff;max-width:440px;width:97vw;border-radius:18px;box-shadow:0 8px 32px #0002;padding:30px 18px 18px 18px;position:relative;display:flex;flex-direction:column;animation:fadeIn 0.3s;border:2px solid #ff9800;\">
          <button id=\"closeNotesSettingsBtn\" style=\"position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;\">✖</button>
          <div style=\"font-size:20px;color:#ff9800;margin-bottom:18px;font-weight:600;text-align:center;\">⚙️ إعدادات صلاحيات الملاحظات</div>
          <div id=\"notesSettingsContent\" style=\"overflow-y:auto;max-height:60vh;\">جاري التحميل...</div>
        </div>
        <style>
          @media (max-width: 600px) {
            #notesSettingsModal > div { max-width:99vw !important; padding:18px 2vw 18px 2vw !important; }
            #notesSettingsModal div { font-size:16px !important; }
          }
          #closeNotesSettingsBtn:hover { background:#b71c1c !important; }
        </style>
      `;
      document.body.appendChild(modal);
      document.getElementById("closeNotesSettingsBtn").onclick = function() { modal.remove(); };
    } else {
      modal.style.display = "flex";
    }
    // تحميل المستخدمين وصلاحياتهم
    db.ref("users").once("value").then(snapshot => {
      const users = snapshot.val() || {};
      let html = `<table style='width:100%;border-collapse:collapse;margin-bottom:10px;'>
        <tr><th style='background:#f6f6f6;'>المستخدم</th><th style='background:#f6f6f6;'>صلاحية الملاحظات</th></tr>`;
      Object.entries(users).forEach(([username, data]) => {
        if (username === "admin") return;
        const perm = data.notesPermission || "edit";
        html += `<tr>
          <td style='padding:7px 4px;'>${username}</td>
          <td style='padding:7px 4px;'>
            <select data-user='${username}' class='notePermSelect' style='font-size:15px;'>
              <option value='edit' ${perm==="edit"?"selected":""}>يستطيع التعديل</option>
              <option value='read' ${perm==="read"?"selected":""}>قراءة فقط</option>
              <option value='none' ${perm==="none"?"selected":""}>مخفي تمامًا</option>
            </select>
          </td>
        </tr>`;
      });
      html += `</table><div style='font-size:13px;color:#555;'>حدد صلاحية الملاحظات لكل مستخدم. التغيير فوري.</div>`;
      document.getElementById("notesSettingsContent").innerHTML = html;
      Array.from(document.getElementsByClassName("notePermSelect")).forEach(sel => {
        sel.onchange = function() {
          const user = sel.getAttribute("data-user");
          const val = sel.value;
          db.ref("users/"+user+"/notesPermission").set(val).then(()=>{
            logActivity("تغيير صلاحية الملاحظات","تم تغيير صلاحية الملاحظات للمستخدم: "+user+" إلى: "+(val==="edit"?"تعديل":val==="read"?"قراءة فقط":"مخفي"));
            updateSidebarVisibility();
          });
        };
      });
    });
  }
  // زر فتح تبويبة الملاحظات
  document.getElementById("sidebarNotesBtn").onclick = function() {
    document.getElementById("sidebarMenu").classList.remove("open");
    setTimeout(showNotesTab, 100);
  };

  // تبويبة الملاحظات الاحترافية
  function showNotesTab() {
    let notesTab = document.getElementById("notesTab");
    if (!notesTab) {
      notesTab = document.createElement("div");
      notesTab.id = "notesTab";
      notesTab.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:7000;display:flex;align-items:center;justify-content:center;`;
      notesTab.innerHTML = `
        <div style=\"background:#fff;max-width:430px;width:97vw;border-radius:16px;box-shadow:0 8px 32px #0002;padding:28px 18px 18px 18px;position:relative;display:flex;flex-direction:column;animation:fadeIn 0.3s;\">
          <button id=\"closeNotesTabBtn\" style=\"position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;\">✖</button>
          <div style=\"font-size:20px;color:#333;margin-bottom:18px;font-weight:600;text-align:center;\">📝 ملاحظات الموظفين</div>
          <div id=\"notesTabContent\" style=\"overflow-y:auto;max-height:60vh;\"></div>
        </div>
        <style>
          @media (max-width: 600px) {
            #notesTab > div { max-width:99vw !important; padding:18px 2vw 18px 2vw !important; }
            #notesTab div { font-size:16px !important; }
          }
          #closeNotesTabBtn:hover { background:#b71c1c !important; }
        </style>
      `;
      document.body.appendChild(notesTab);
      document.getElementById("closeNotesTabBtn").onclick = function() { notesTab.remove(); };
    } else {
      notesTab.style.display = "flex";
    }
    renderNotesTabContent();
  }

  // عرض صناديق الملاحظات لكل موظف
  function renderNotesTabContent() {
    const notesDiv = document.getElementById("notesTabContent");
    notesDiv.innerHTML = "جاري التحميل...";
    db.ref("notes").once("value").then(snapshot => {
      const notes = snapshot.val() || {};
      db.ref("users/"+currentUser).once("value").then(userSnap => {
        const userData = userSnap.val() || {};
        const perm = userData.notesPermission || "edit";
        let html = "";
        employees.forEach(emp => {
          html += `<div style='margin-bottom:18px;padding:12px 10px;background:#f7f7f7;border-radius:10px;'>
            <div style='font-weight:500;color:#007bff;margin-bottom:7px;'>${emp}</div>`;
          if (perm === "edit") {
            html += `<textarea id='noteInput_${emp}' style='width:98%;min-height:48px;border-radius:7px;border:1px solid #ccc;padding:7px;font-size:15px;'>${notes[emp] ? notes[emp] : ""}</textarea>
            <button class='saveNoteBtn' data-emp='${emp}' style='margin-top:7px;background:#ffb300;color:#333;padding:6px 18px;border:none;border-radius:6px;font-size:15px;cursor:pointer;'>💾 حفظ الملاحظة</button>`;
          } else if (perm === "read") {
            html += `<textarea id='noteInput_${emp}' style='width:98%;min-height:48px;border-radius:7px;border:1px solid #ccc;padding:7px;font-size:15px;background:#eee;' readonly>${notes[emp] ? notes[emp] : ""}</textarea>`;
          } else {
            html += `<div style='color:#888;font-size:14px;'>لا يوجد صلاحية لعرض الملاحظات</div>`;
          }
          html += `</div>`;
        });
        notesDiv.innerHTML = html;
        if (perm === "edit") {
          Array.from(document.getElementsByClassName("saveNoteBtn")).forEach(btn => {
            btn.onclick = function() {
              const emp = btn.getAttribute("data-emp");
              const noteVal = document.getElementById(`noteInput_${emp}`).value;
              db.ref("notes/" + emp).set(noteVal).then(() => {
                btn.textContent = "✅ تم الحفظ";
                setTimeout(() => { btn.textContent = "💾 حفظ الملاحظة"; }, 1200);
                logActivity(
                  "تعديل ملاحظة موظف",
                  `<span style='color:#007bff;font-weight:bold;'>${emp}</span> | <span style='color:#ffb300;'>${noteVal.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</span>`,
                  { type: "note", emp: emp }
                );
              });
            };
          });
        }
      });
    });
  }
  // تحديث ظهور الأزرار حسب الدور وصلاحية المستخدم
  function updateSidebarVisibility() {
    const sidebarToggleBtn = document.getElementById("sidebarToggleBtn");
    const sidebarMenu = document.getElementById("sidebarMenu");
    const sidebarCloseBtn = document.getElementById("sidebarCloseBtn");
    const isAdmin = currentUserRole === "admin";
    // أزرار المدير فقط
    ["sidebarAdminBtn","sidebarEmpStatsBtn","sidebarDeleteDataBtn","sidebarFeaturesTabBtn","sidebarChangePassBtn","sidebarUserControlBtn","sidebarNotesSettingsBtn"].forEach(id=>{
      const el = document.getElementById(id);
      if (el) el.style.display = isAdmin ? "block" : "none";
    });

    // زر الملاحظات: يظهر فقط إذا كان للمستخدم صلاحية (edit أو read)
    db.ref("users/"+currentUser).once("value").then(snap=>{
      const data = snap.val()||{};
      const perm = data.notesPermission || "edit";
      const notesBtn = document.getElementById("sidebarNotesBtn");
      if (notesBtn) {
        if (perm === "edit" || perm === "read") {
          notesBtn.style.display = "block";
        } else {
          notesBtn.style.display = "none";
        }
      }
    });

    // زر سجل النشاطات يظهر فقط إذا كان للمستخدم صلاحية
    db.ref("users/" + currentUser).once("value").then(snapshot => {
      const data = snapshot.val() || {};
      let logBtn = document.getElementById("sidebarUserLogBtn");
      if (data.canViewLog) {
        if (!logBtn) {
          logBtn = document.createElement("button");
          logBtn.id = "sidebarUserLogBtn";
          logBtn.style = "background:#673ab7;color:white;";
          logBtn.textContent = "📋 سجل النشاطات";
          logBtn.onclick = function() {
            document.getElementById("sidebarMenu").classList.remove("open");
            // نافذة سجل النشاطات للمستخدم
            let modal = document.getElementById("userLogModal");
            if (!modal) {
              modal = document.createElement("div");
              modal.id = "userLogModal";
              modal.style.position = "fixed";
              modal.style.top = "0";
              modal.style.left = "0";
              modal.style.width = "100vw";
              modal.style.height = "100vh";
              modal.style.background = "rgba(0,0,0,0.35)";
              modal.style.zIndex = "7000";
              modal.style.display = "flex";
              modal.style.alignItems = "center";
              modal.style.justifyContent = "center";
              modal.innerHTML = `
                <div style="background:#fff;max-width:400px;width:95vw;border-radius:12px;box-shadow:0 8px 32px #0002;padding:22px 18px 18px 18px;position:relative;">
                  <button id="closeUserLogModal" style="position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:28px;height:28px;font-size:16px;cursor:pointer;">✖</button>
                  <h3 style="text-align:center;margin-bottom:18px;color:#673ab7;">📋 سجل النشاطات</h3>
                  <div id="userLogContent">جاري التحميل...</div>
                </div>
              `;
              document.body.appendChild(modal);
              document.getElementById("closeUserLogModal").onclick = function() {
                modal.style.display = "none";
              };
            } else {
              modal.style.display = "flex";
            }
            // تحميل سجل النشاطات لهذا المستخدم فقط
            db.ref("activityLog").orderByChild("user").equalTo(currentUser).limitToLast(30).once("value").then(snapshot => {
              const log = snapshot.val() || {};
              let html = `<table class="activity-log-table">
                <tr>
                  <th>الوقت</th>
                  <th>النشاط</th>
                  <th>الوصف</th>
                </tr>`;
              Object.values(log).reverse().forEach(item => {
                html += `<tr>
                  <td>${toEnglishNumbers(item.time || "")}</td>
                  <td>${item.action || ""}</td>
                  <td>${item.details || ""}</td>
                </tr>`;
              });
              html += `</table>`;
              document.getElementById("userLogContent").innerHTML = html;
            });
          };
          sidebarMenu.appendChild(logBtn);
        } else {
          logBtn.style.display = "block";
        }
      } else {
        if (logBtn) logBtn.style.display = "none";
      }
    });

    if (localStorage.getItem('loggedUser')) {
      sidebarToggleBtn.style.display = sidebarMenu.classList.contains("open") ? "none" : "flex";
      sidebarCloseBtn.style.display = sidebarMenu.classList.contains("open") ? "flex" : "none";
    } else {
      sidebarToggleBtn.style.display = "none";
      sidebarCloseBtn.style.display = "none";
      sidebarMenu.classList.remove("open");
    }
  }
  // زر فتح القائمة الجانبية
  document.getElementById("sidebarToggleBtn").onclick = () => {
    document.getElementById("sidebarMenu").classList.add("open");
    document.getElementById("sidebarToggleBtn").style.display = "none";
    document.getElementById("sidebarCloseBtn").style.display = "flex";
    // عرض اسم المستخدم أعلى القائمة
    const sidebarUserName = document.getElementById("sidebarUserName");
    sidebarUserName.textContent = currentUser ? "👤 " + currentUser : "غير مسجل";
    updateSidebarVisibility();
  };
  // زر إغلاق القائمة الجانبية
  document.getElementById("sidebarCloseBtn").onclick = () => {
    document.getElementById("sidebarMenu").classList.remove("open");
    document.getElementById("sidebarCloseBtn").style.display = "none";
    document.getElementById("sidebarToggleBtn").style.display = "flex";
    updateSidebarVisibility();
  };
  // ربط أزرار القائمة الجانبية بأزرار الموقع الأصلية
  document.getElementById("sidebarAdminBtn").onclick = () => {
    document.getElementById("sidebarMenu").classList.remove("open");
    setTimeout(()=>document.getElementById("toggleAdminBtn").click(),100);
  };
  document.getElementById("sidebarEmpStatsBtn").onclick = () => {
    document.getElementById("sidebarMenu").classList.remove("open");
    setTimeout(()=>document.getElementById("toggleEmpStatsBtn").click(),100);
  };
  document.getElementById("sidebarDeleteDataBtn").onclick = () => {
    document.getElementById("sidebarMenu").classList.remove("open");
    setTimeout(()=>document.getElementById("btnDeleteData").click(),100);
  };
  document.getElementById("sidebarFeaturesTabBtn").onclick = () => {
    document.getElementById("sidebarMenu").classList.remove("open");
    setTimeout(()=>{
      document.getElementById("btnFeaturesTab").click();
      document.getElementById("featuresTab").style.display = "flex";
      const featuresTabContent = document.getElementById("featuresTabContent");
      featuresTabContent.innerHTML = `
        <div class="feature-section">
          <h4>سجل النشاطات</h4>
          <div id="activityLogBox">جاري التحميل...</div>
        </div>
        <div class="feature-section">
          <h4>معلومات النظام</h4>
          <ul style="margin:0;padding:0 0 0 15px;">
            <li>عدد الموظفين الحالي: <b>${employees.length}</b></li>
            <li>اسم المستخدم الحالي: <b>${currentUser}</b></li>
            <li>الدور: <b>${currentUserRole}</b></li>
          </ul>
        </div>
      `;
      db.ref("activityLog").limitToLast(30).once("value").then(snapshot => {
        const log = snapshot.val() || {};
        let html = `<table class="activity-log-table">
          <tr>
            <th>الوقت</th>
            <th>المستخدم</th>
            <th>النشاط</th>
            <th>الوصف</th>
          </tr>`;
        Object.values(log).reverse().forEach(item => {
          html += `<tr>
            <td>${toEnglishNumbers(item.time || "")}</td>
            <td>${item.user || ""}</td>
            <td>${item.action || ""}</td>
            <td>${item.details || ""}</td>
          </tr>`;
        });
        html += `</table>`;
        document.getElementById("activityLogBox").innerHTML = html;
      });
      // زر إغلاق التبويبة
      const closeBtn = document.getElementById("closeFeaturesTab");
      if (closeBtn) {
        closeBtn.onclick = () => {
          document.getElementById("featuresTab").style.display = "none";
        };
      }
    },100);
  };
  // إخفاء جميع الأزرار الخارجية
  document.addEventListener("DOMContentLoaded", () => {
    ["btnDownloadPDF", "toggleAdminBtn", "toggleEmpStatsBtn", "btnDeleteData", "btnFeaturesTab"].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.style.display = "none";
    });
    updateSidebarVisibility();
  });
  window.addEventListener("storage", updateSidebarVisibility);
  window.addEventListener("focus", updateSidebarVisibility);
  setInterval(updateSidebarVisibility, 1000);
</script>
<!-- نهاية الإضافة -->

<!-- سجل النشاطات - تحسين التفاصيل -->
<script>
// سجل النشاطات
function logActivity(action, details, extra = {}) {
  const now = new Date();
  const time = toEnglishNumbers(now.toLocaleDateString('ar-EG')) + ' ' + toEnglishNumbers(now.toLocaleTimeString('ar-EG'));
  let style = "";
  if (extra && extra.type === "note") {
    style = "background:#fffde7;border-left:5px solid #ffb300;";
  }
  db.ref("activityLog").push({
    time,
    action,
    details,
    user: currentUser,
    ...extra,
    style
  });
}

// تحويل الأرقام العربية إلى إنجليزية
function toEnglishNumbers(str) {
  return str.replace(/[٠-٩]/g, d => "٠١٢٣٤٥٦٧٨٩".indexOf(d));
}

// حفظ التعديلات فقط عند وجود تغيير فعلي
async function saveData() {
  if (!currentUserCanEdit) {
    alert("❌ ليس لديك صلاحية تعديل الجدول.");
    return;
  }
  const days = getDays();
  try {
    const attendanceSnapshot = await db.ref("attendance").once("value");
    const savedData = attendanceSnapshot.val() || {};
    const updatedData = {...savedData};
    let changes = [];
    let anyChange = false;
    days.forEach((day, dayIndex) => {
      if (!updatedData[day.key]) updatedData[day.key] = {};
      let dayChanged = false;
      employees.forEach((employee, empIndex) => {
        const selectElement = document.getElementById(`d${dayIndex}e${empIndex}`);
        if (selectElement) {
          const newValue = selectElement.value;
          const oldValue = savedData[day.key] ? savedData[day.key][employee] : "";
          if (newValue !== oldValue) {
            updatedData[day.key][employee] = newValue;
            dayChanged = true;
            anyChange = true;
            changes.push({
              user: currentUser,
              day: day.key,
              employee,
              old: oldValue,
              new: newValue,
              time: new Date().toLocaleString('ar-EG')
            });
          }
        }
      });
      if (dayChanged) {
        updatedData[day.key].__editor = currentUser;
        const now = new Date();
        const ts = now.toLocaleDateString('ar-EG') + ' ' + now.toLocaleTimeString('ar-EG');
        updatedData[day.key].__editedAt = ts;
      }
    });
    if (!anyChange) {
      alert("لا يوجد أي تعديل لحفظه.");
      return;
    }
    await db.ref("attendance").set(updatedData);
    alert("✅ تم حفظ التعديلات بنجاح");
    generateTable();
    changes.forEach(change => {
      logActivity(
        "تعديل جدول الحضور",
        `
          <span style="color:#007bff;font-weight:bold;">${change.user}</span>
          قام بتعديل حضور الموظف
          <span style="color:#673ab7;font-weight:bold;">${change.employee}</span>
          في اليوم
          <span style="color:#009688;font-weight:bold;">${change.day}</span>
          من
          <span style="background:#d4edda;padding:2px 6px;border-radius:5px;">${change.old || "بدون"}</span>
          إلى
          <span style="background:#fff9db;padding:2px 6px;border-radius:5px;">${change.new || "بدون"}</span>
        `,
        { time: change.time, user: change.user }
      );
    });
  } catch (error) {
    console.error("خطأ في حفظ البيانات:", error);
    alert("❌ خطأ في حفظ البيانات");
  }
}

// زر ميزات متقدمة + زر الإغلاق
document.getElementById("sidebarFeaturesTabBtn").onclick = () => {
  document.getElementById("sidebarMenu").classList.remove("open");
  document.getElementById("btnFeaturesTab").click();
  document.getElementById("featuresTab").style.display = "flex";
  const featuresTabContent = document.getElementById("featuresTabContent");
  featuresTabContent.innerHTML = `
    <div class="feature-section">
      <h4>سجل النشاطات</h4>
      <div id="activityLogBox">جاري التحميل...</div>
    </div>
    <div class="feature-section">
      <h4>معلومات النظام</h4>
      <ul style="margin:0;padding:0 0 0 15px;">
        <li>عدد الموظفين الحالي: <b>${employees.length}</b></li>
        <li>اسم المستخدم الحالي: <b>${currentUser}</b></li>
        <li>الدور: <b>${currentUserRole}</b></li>
      </ul>
    </div>
  `;
  db.ref("activityLog").limitToLast(30).once("value").then(snapshot => {
      const log = snapshot.val() || {};
      let html = `<table class="activity-log-table" style="width:100%;border-collapse:collapse;">
        <tr>
          <th style='background:#f0f0f0;padding:7px;'>الوقت</th>
          <th style='background:#f0f0f0;padding:7px;'>المستخدم</th>
          <th style='background:#f0f0f0;padding:7px;'>النشاط</th>
          <th style='background:#f0f0f0;padding:7px;'>الوصف</th>
        </tr>`;
      Object.values(log).reverse().forEach(item => {
        html += `<tr style='${item.style || ""}'>
          <td>${toEnglishNumbers(item.time || "")}</td>
          <td>${item.user || ""}</td>
          <td>${item.action || ""}</td>
          <td>${item.details || ""}</td>
        </tr>`;
      });
      html += `</table>`;
      document.getElementById("activityLogBox").innerHTML = html;
  });
  // زر إغلاق التبويبة
  const closeBtn = document.getElementById("closeFeaturesTab");
  if (closeBtn) {
    closeBtn.onclick = () => {
      document.getElementById("featuresTab").style.display = "none";
    };
  }
};


// نافذة تحكم صلاحيات سجل النشاطات للمدير
document.getElementById("sidebarUserControlBtn").onclick = function() {
  // إنشاء نافذة منبثقة احترافية
  let modal = document.getElementById("userLogControlModal");
  if (!modal) {
    modal = document.createElement("div");
    modal.id = "userLogControlModal";
    modal.style.position = "fixed";
    modal.style.top = "0";
    modal.style.left = "0";
    modal.style.width = "100vw";
    modal.style.height = "100vh";
    modal.style.background = "rgba(0,0,0,0.35)";
    modal.style.zIndex = "8000";
    modal.style.display = "flex";
    modal.style.alignItems = "center";
    modal.style.justifyContent = "center";
    modal.innerHTML = `
      <div style="background:#fff;max-width:420px;width:95vw;border-radius:14px;box-shadow:0 8px 32px #0002;padding:28px 20px 20px 20px;position:relative;">
        <button id="closeUserLogControlModal" style="position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;">✖</button>
        <h3 style="text-align:center;margin-bottom:18px;color:#009688;">👥 إدارة صلاحيات سجل النشاطات</h3>
        <div id="userLogControlContent" style="min-height:70px;">جاري التحميل...</div>
      </div>
    `;
    document.body.appendChild(modal);
    document.getElementById("closeUserLogControlModal").onclick = function() {
      modal.style.display = "none";
    };
  } else {
    modal.style.display = "flex";
  }

  // تحميل المستخدمين وصلاحياتهم
  db.ref("users").once("value").then(snapshot => {
    const users = snapshot.val() || {};
    let html = `<table style="width:100%;border-collapse:collapse;margin-bottom:10px;">
      <tr>
        <th style="background:#f6f6f6;">المستخدم</th>
        <th style="background:#f6f6f6;">الوصول لسجل النشاطات</th>
      </tr>`;
    Object.entries(users).forEach(([username, data]) => {
      if (username === "admin") return; // لا تظهر للمدير نفسه
      html += `<tr>
        <td style="padding:7px 4px;">${username}</td>
        <td style="padding:7px 4px;">
          <label style="display:inline-flex;align-items:center;gap:6px;">
            <input type="checkbox" ${data.canViewLog ? "checked" : ""} onchange="window.setUserLogAccess('${username}', this.checked)">
            <span style="font-size:13px;color:${data.canViewLog ? '#28a745':'#dc3545'};">${data.canViewLog ? 'مفعل':'معطل'}</span>
          </label>
        </td>
      </tr>`;
    });
    html += `</table>
      <div style="margin-top:10px;font-size:13px;color:#555;">
        عند تفعيل الصلاحية يظهر زر سجل النشاطات للمستخدم في القائمة الجانبية.<br>
        عند التعطيل يختفي الزر مباشرة من عند المستخدم.
      </div>`;
    document.getElementById("userLogControlContent").innerHTML = html;
    window.setUserLogAccess = function(username, enabled) {
      db.ref("users/" + username + "/canViewLog").set(enabled).then(() => {
        logActivity("تغيير صلاحية سجل النشاطات", `تم ${enabled ? 'تفعيل' : 'تعطيل'} سجل النشاطات للمستخدم: ${username}`);
        updateSidebarVisibility();
      });
    };
  });
}
</script>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
// ========== إعداد Firebase ==========
const firebaseConfig = {
  apiKey: "AIzaSyDh8KquT-8Slr6B5SAGoyGj2zOEusyiEg4",
  authDomain: "sjad-b3946.firebaseapp.com",
  databaseURL: "https://sjad-b3946-default-rtdb.firebaseio.com",
  projectId: "sjad-b3946",
  storageBucket: "sjad-b3946.appspot.com",
  messagingSenderId: "1001672753514",
  appId: "1:1001672753514:web:eac813b6e25621f5d16513",
  measurementId: "G-EV0NVW2036"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let employees = [];
// ========== استرجاع الجلسة عند تحديث الصفحة ========== (مع مراقبة صلاحية التعديل)
document.addEventListener("DOMContentLoaded", function() {
  if (localStorage.getItem('loggedUser')) {
    const userObj = JSON.parse(localStorage.getItem('loggedUser'));
    currentUser = userObj.user;
    currentUserRole = userObj.role;
    currentUserCanEdit = userObj.canEdit;
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("mainContent").style.display = "block";
    if (currentUserRole === "admin") {
      document.getElementById("adminPanel").style.display = "block";
      loadUsers();
      loadEmployeesTable();
    } else {
      document.getElementById("adminPanel").style.display = "none";
    }
    loadEmployees().then(() => {
      generateTable();
      if (typeof tryShowUserEmpStats === "function") tryShowUserEmpStats();
    });
    if (typeof checkForcedLogoutOnLogin === "function") checkForcedLogoutOnLogin(currentUser);
    if (typeof updateSidebarVisibility === "function") updateSidebarVisibility();
    if (typeof loadAvailableMonths === "function") loadAvailableMonths();

    // مراقبة صلاحية التعديل للمستخدم الحالي وتحديثها فوراً
    if (currentUser !== "admin") {
      db.ref("users/" + currentUser + "/canEdit").on("value", function(snap) {
        const newCanEdit = !!snap.val();
        if (currentUserCanEdit !== newCanEdit) {
          currentUserCanEdit = newCanEdit;
          // إعادة توليد الجدول لتعطيل/تفعيل الحقول فوراً
          generateTable();
          // إشعار المستخدم إذا تم تعطيل التعديل
          if (!currentUserCanEdit) {
            showPermissionRevokedModal();
          }
// نافذة منبثقة لإشعار تعطيل الصلاحية
function showPermissionRevokedModal() {
  let oldModal = document.getElementById("permRevokedModal");
  if (oldModal) oldModal.remove();
  const modal = document.createElement("div");
  modal.id = "permRevokedModal";
  modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:9999;display:flex;align-items:center;justify-content:center;`;
  modal.innerHTML = `
    <div style=\"background:linear-gradient(135deg,#f7faff 60%,#e3eafc 100%);max-width:370px;width:92vw;padding:32px 20px 22px 20px;border-radius:18px;box-shadow:0 8px 32px #1976d233;position:relative;text-align:center;animation:fadeIn 0.3s;\">
      <button id=\"closePermRevokedModalBtn\" style=\"position:absolute;top:10px;left:10px;background:#e57373;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;transition:background 0.2s;box-shadow:0 2px 8px #e5737322;\">✖</button>
      <div style=\"font-size:21px;color:#d32f2f;margin-bottom:18px;font-weight:700;letter-spacing:0.2px;\">🚫 تم تعطيل صلاحية التعديل</div>
      <div style=\"font-size:16.5px;color:#2d3a4a;line-height:1.8;margin-bottom:16px;background:#fff3f3;border-radius:8px;padding:10px 7px 8px 7px;box-shadow:0 1px 4px #e5737311;\">تم قفل صلاحية التعديل الخاصة بك من قبل المدير.<br>لن تتمكن من تعديل الجدول حتى إشعار آخر.</div>
      <button id=\"permRevokedOkBtn\" style=\"background:linear-gradient(90deg,#1976d2 60%,#42a5f5 100%);color:white;padding:11px 0;border:none;border-radius:8px;font-size:17px;cursor:pointer;box-shadow:0 2px 8px #1976d222;width:90%;margin-top:8px;font-weight:600;transition:background 0.2s;\">حسناً</button>
    </div>
    <style>
      @keyframes fadeIn { from { opacity:0; transform:scale(0.95);} to { opacity:1; transform:scale(1);} }
      @media (max-width: 600px) {
        #permRevokedModal > div { max-width:99vw !important; padding:18px 2vw 18px 2vw !important; }
        #permRevokedModal div { font-size:16px !important; }
      }
      #closePermRevokedModalBtn:hover { background:#b71c1c !important; }
      #permRevokedOkBtn:hover { background:#1565c0 !important; }
    </style>
  `;
  document.body.appendChild(modal);
  document.getElementById("permRevokedOkBtn").onclick = () => { modal.remove(); };
  document.getElementById("closePermRevokedModalBtn").onclick = () => { modal.remove(); };
}
        }
      });
    }
  }
});
const statuses = ["", "شفت", "نص", "❌"];
let month = new Date().getMonth();
const year = new Date().getFullYear();
const arMonths = ["كانون الثاني","شباط","آذار","نيسان","أيار","حزيران","تموز","آب","أيلول","تشرين الأول","تشرين الثاني","كانون الأول"];
let currentUser = "";
let currentUserRole = "";
let currentUserCanEdit = false;

// ========== سجل النشاطات ==========
function logActivity(action, details, extra = {}) {
  const now = new Date();
  const time = toEnglishNumbers(now.toLocaleDateString('ar-EG')) + ' ' + toEnglishNumbers(now.toLocaleTimeString('ar-EG'));
  db.ref("activityLog").push({ time, action, details, user: currentUser, ...extra });
}

// ========== جلسة المستخدم ==========
function setSession(userObj) {
  currentUser = userObj.user;
  currentUserRole = userObj.role;
  currentUserCanEdit = userObj.canEdit;
  localStorage.setItem('loggedUser', JSON.stringify(userObj));
}
function clearSession() {
  currentUser = "";
  currentUserRole = "";
  currentUserCanEdit = false;
  localStorage.removeItem('loggedUser');
}

// ========== رسائل واجهة المستخدم ==========
function showMessage(message, isError = false) {
  const messageDiv = document.getElementById("loginMessage");
  messageDiv.innerHTML = message;
  messageDiv.className = isError ? "error" : "loading";
}

// ========== تسجيل الدخول ==========
function login() {
  const username = document.getElementById("username").value.trim().toLowerCase();
  const password = document.getElementById("password").value.trim();
  if (!username || !password) return showMessage("❌ يرجى إدخال اسم المستخدم وكلمة المرور", true);
  showMessage("🔄 جاري تسجيل الدخول...");
  db.ref("users/" + username).once("value").then(snapshot => {
    if (!snapshot.exists()) throw new Error("User not found");
    const userData = snapshot.val();
    if (userData.password !== password) throw new Error("Wrong password");
    setSession({user: username, role: userData.role || "user", canEdit: userData.canEdit !== undefined ? userData.canEdit : true});
    showMessage("");
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("mainContent").style.display = "block";
    loadEmployees().then(generateTable);
    if (currentUserRole === "admin") {
      document.getElementById("adminPanel").style.display = "block";
      loadUsers();
      loadEmployeesTable();
    } else {
      document.getElementById("adminPanel").style.display = "none";
    }
    checkForcedLogoutOnLogin(username);
  }).catch(error => {
    showMessage(error.message === "User not found" ? "❌ اسم المستخدم غير موجود" : "❌ كلمة المرور غير صحيحة", true);
  });
}

function logout() {
  clearSession();
  document.getElementById("loginBox").style.display = "block";
  document.getElementById("mainContent").style.display = "none";
  document.getElementById("adminPanel").style.display = "none";
  document.getElementById("username").value = "";
  document.getElementById("password").value = "";
  showMessage("");
}

// ========== تحميل الموظفين ==========
function loadEmployees() {
  
  return db.ref("employees").once("value").then(snapshot => {
    employees = snapshot.exists() ? Object.values(snapshot.val()) : [];
    const theadRow = document.querySelector("#attendanceTable thead tr");
    while (theadRow.children.length > 1) theadRow.removeChild(theadRow.lastChild);
    // Make all header cells (including 'التاريخ') unified in color and style
    // First, update the first th ("التاريخ")
    if (theadRow.children.length > 0) {
      const firstTh = theadRow.children[0];
      firstTh.style.background = '#e3f0ff'; // calm blue
      firstTh.style.color = '#222'; // black text
      firstTh.style.fontWeight = 'bold';
      firstTh.style.fontSize = '17px';
      firstTh.style.border = '1px solid #b0bec5'; // add grid border
      firstTh.style.boxShadow = 'none';
      firstTh.style.letterSpacing = '0.5px';
      firstTh.style.borderRadius = '0';
      firstTh.style.transition = 'background 0.2s';
    }
    employees.forEach(emp => {
      const th = document.createElement("th");
      th.textContent = emp;
      th.style.background = '#e3f0ff'; // calm blue
      th.style.color = '#222'; // black text
      th.style.fontWeight = 'bold';
      th.style.fontSize = '17px';
      th.style.border = '1px solid #b0bec5'; // add grid border
      th.style.boxShadow = 'none';
      th.style.letterSpacing = '0.5px';
      th.style.borderRadius = '0';
      th.style.transition = 'background 0.2s';
      theadRow.appendChild(th);
    });
    loadEmployeesTable();
  });
}

// ========== جدول الحضور ==========
function getDays() {
  const days = [];
  let date = new Date(year, month, 1);
  while (date.getMonth() === month) {
    const dayKey = `${year}-${month + 1}-${date.getDate()}`;
    const dayLabel = `${date.getDate()} ${arMonths[month]} (${date.toLocaleDateString('ar-EG', {weekday: 'long'})})`;
    days.push({key: dayKey, label: dayLabel});
    date.setDate(date.getDate() + 1);
  }
  return days;
}

function generateTable() {
  const days = getDays();
  // تحديث عنوان الجدول باسم الشهر الحالي
  document.querySelector("#mainContent h2").textContent = `📋 جدول الحضور - ${arMonths[month]}`;
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";
  db.ref("attendance").once("value").then(snapshot => {
    const savedData = snapshot.val() || {};
    days.forEach((day, dayIndex) => {
      const row = document.createElement("tr");
      const dateCell = document.createElement("td");
      let dateContent = toEnglishNumbers(day.label);
      if (savedData[day.key] && savedData[day.key].__editor) {
        const ts = savedData[day.key].__editedAt || "";
        const editor = savedData[day.key].__editor;
        const color = (editor === "admin") ? "#1fa745" : "#dc3545";
        dateContent += `<div class='editor-tag' style="color:${color};font-weight:bold;">
          🖊️ ${editor}${ts ? ' - ' + toEnglishNumbers(ts) : ''}
        </div>`;
      }
      dateCell.innerHTML = dateContent;
      row.appendChild(dateCell);
      employees.forEach((employee, empIndex) => {
        const cell = document.createElement("td");
        const select = document.createElement("select");
        select.id = `d${dayIndex}e${empIndex}`;
        statuses.forEach(status => {
          const option = document.createElement("option");
          option.value = status;
          option.textContent = status;
          select.appendChild(option);
        });
        if (savedData[day.key] && savedData[day.key][employee] !== undefined) {
          select.value = savedData[day.key][employee];
        }
        if (select.value === "شفت") {
          cell.style.background = "#d4edda";
        } else if (select.value === "نص") {
          cell.style.background = "#fff9db";
        } else if (select.value === "❌") {
          cell.style.background = "#ffe3e3";
          cell.style.color = "#d32f2f";
          select.style.color = "#d32f2f";
        } else {
          cell.style.color = "";
          select.style.color = "";
        }
        if (!currentUserCanEdit) {
          select.setAttribute('disabled','disabled');
          select.addEventListener('change', (e)=>{ e.target.value = savedData[day.key] ? savedData[day.key][employee] : ""; });
        }
        select.addEventListener('change', function() {
          if (this.value === "شفت") {
            cell.style.background = "#d4edda";
            cell.style.color = "";
            select.style.color = "";
          } else if (this.value === "نص") {
            cell.style.background = "#fff9db";
            cell.style.color = "";
            select.style.color = "";
          } else if (this.value === "❌") {
            cell.style.background = "#ffe3e3";
            cell.style.color = "#d32f2f";
            select.style.color = "#d32f2f";
          } else {
            cell.style.background = "";
            cell.style.color = "";
            select.style.color = "";
          }
        });
        cell.appendChild(select);
        row.appendChild(cell);
      });
      tbody.appendChild(row);
    });
    // تعطيل زر الحفظ إذا لم يكن للمستخدم صلاحية
    const saveBtn = document.querySelector('button[onclick="saveData()"]');
    if (saveBtn) saveBtn.disabled = !currentUserCanEdit;
    calculateStats(savedData);
  });
  // تعطيل جميع select وinput وtextarea وأزرار الحفظ إذا فقدت الصلاحية (احتياطي)
  setTimeout(()=>{
    if (!currentUserCanEdit) {
      document.querySelectorAll('#mainContent select, #mainContent input, #mainContent textarea').forEach(el=>{
        el.setAttribute('disabled','disabled');
      });
      const saveBtn = document.querySelector('button[onclick="saveData()"]');
      if (saveBtn) saveBtn.disabled = true;
    } else {
      document.querySelectorAll('#mainContent select, #mainContent input, #mainContent textarea').forEach(el=>{
        el.removeAttribute('disabled');
      });
      const saveBtn = document.querySelector('button[onclick="saveData()"]');
      if (saveBtn) saveBtn.disabled = false;
    }
  }, 100);
}

// ========== حفظ البيانات ==========
async function saveData() {
  if (!currentUserCanEdit) {
    alert("❌ ليس لديك صلاحية تعديل الجدول.");
    return;
  }
  const days = getDays();
  try {
    const attendanceSnapshot = await db.ref("attendance").once("value");
    const savedData = attendanceSnapshot.val() || {};
    const updatedData = {...savedData};
    let changes = [];
    let anyChange = false;
    days.forEach((day, dayIndex) => {
      if (!updatedData[day.key]) updatedData[day.key] = {};
      let dayChanged = false;
      employees.forEach((employee, empIndex) => {
        const selectElement = document.getElementById(`d${dayIndex}e${empIndex}`);
        if (selectElement) {
          const newValue = selectElement.value;
          const oldValue = savedData[day.key] ? savedData[day.key][employee] : "";
          if (newValue !== oldValue) {
            updatedData[day.key][employee] = newValue;
            dayChanged = true;
            anyChange = true;
            changes.push({
              user: currentUser,
              day: day.key,
              employee,
              old: oldValue,
              new: newValue,
              time: new Date().toLocaleString('ar-EG')
            });
          }
        }
      });
      if (dayChanged) {
        updatedData[day.key].__editor = currentUser;
        const now = new Date();
        const ts = now.toLocaleDateString('ar-EG') + ' ' + now.toLocaleTimeString('ar-EG');
        updatedData[day.key].__editedAt = ts;
      }
    });
    if (!anyChange) {
      alert("لا يوجد أي تعديل لحفظه.");
      return;
    }
    await db.ref("attendance").set(updatedData);
    alert("✅ تم حفظ التعديلات بنجاح");
    generateTable();
    changes.forEach(change => {
      logActivity(
        "تعديل جدول الحضور",
        `
          <span style="color:#007bff;font-weight:bold;">${change.user}</span>
          قام بتعديل حضور الموظف
          <span style="color:#673ab7;font-weight:bold;">${change.employee}</span>
          في اليوم
          <span style="color:#009688;font-weight:bold;">${change.day}</span>
          من
          <span style="background:#d4edda;padding:2px 6px;border-radius:5px;">${change.old || "بدون"}</span>
          إلى
          <span style="background:#fff9db;padding:2px 6px;border-radius:5px;">${change.new || "بدون"}</span>
        `,
        { time: change.time, user: change.user }
      );
    });
  } catch (error) {
    console.error("خطأ في حفظ البيانات:", error);
    alert("❌ خطأ في حفظ البيانات");
  }
}

// ========== إدارة المستخدمين والموظفين ==========
// ========== إدارة المستخدمين ========== 
// نافذة تأكيد احترافية
function showConfirmModal(message, onConfirm, onCancel) {
  let oldModal = document.getElementById("customConfirmModal");
  if (oldModal) oldModal.remove();
  const modal = document.createElement("div");
  modal.id = "customConfirmModal";
  modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:9999;display:flex;align-items:center;justify-content:center;`;
  modal.innerHTML = `
    <div style=\"background:#fff;max-width:370px;width:92vw;padding:26px 18px 20px 18px;border-radius:16px;box-shadow:0 8px 32px #0002;position:relative;text-align:center;animation:fadeIn 0.3s;\">
      <button id=\"closeConfirmModalBtn\" style=\"position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;transition:background 0.2s;\">✖</button>
      <div style=\"font-size:18px;color:#333;margin-bottom:20px;font-weight:500;\">${message}</div>
      <div style=\"display:flex;gap:12px;justify-content:center;\">
        <button id=\"confirmModalYes\" style=\"background:#007bff;color:white;padding:10px 22px;border:none;border-radius:7px;font-size:17px;cursor:pointer;box-shadow:0 2px 8px #007bff22;transition:background 0.2s;\">تأكيد</button>
        <button id=\"confirmModalNo\" style=\"background:#6c757d;color:white;padding:10px 22px;border:none;border-radius:7px;font-size:17px;cursor:pointer;box-shadow:0 2px 8px #6c757d22;transition:background 0.2s;\">إلغاء</button>
      </div>
    </div>
    <style>
      @keyframes fadeIn { from { opacity:0; transform:scale(0.95);} to { opacity:1; transform:scale(1);} }
      @media (max-width: 600px) {
        #customConfirmModal > div { max-width:99vw !important; padding:18px 2vw 18px 2vw !important; }
        #customConfirmModal div { font-size:16px !important; }
      }
      #closeConfirmModalBtn:hover { background:#b71c1c !important; }
      #confirmModalYes:hover { background:#0056b3 !important; }
      #confirmModalNo:hover { background:#343a40 !important; }
    </style>
  `;
  document.body.appendChild(modal);
  document.getElementById("confirmModalYes").onclick = () => { modal.remove(); if (onConfirm) onConfirm(); };
  document.getElementById("confirmModalNo").onclick = () => { modal.remove(); if (onCancel) onCancel(); };
  document.getElementById("closeConfirmModalBtn").onclick = () => { modal.remove(); if (onCancel) onCancel(); };
}
// تحميل جدول المستخدمين
async function loadUsers() {
  const snapshot = await db.ref("users").once("value");
  const users = snapshot.val() || {};
  const tbody = document.getElementById("usersBody");
  tbody.innerHTML = "";
  Object.entries(users).forEach(([username, data]) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${username}</td>
      <td>${data.canEdit ? "نعم" : "لا"}</td>
      <td>
        <button class="small-button btn-toggle" onclick="toggleUserEdit('${username}', ${data.canEdit})">
          ${data.canEdit ? "قفل التعديل" : "فتح التعديل"}
        </button>
      </td>
      <td>
        ${username === currentUser ? "لا يمكن حذف نفسك" : `<button class="small-button btn-delete" onclick="deleteUser('${username}')">حذف</button>`}
      </td>
      <td>
        ${username === currentUser ? "—" : `<button class="small-button btn-delete" style="background:#ff9800;" onclick="forceLogoutUser('${username}')">تسجيل خروج</button>`}
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// تسجيل خروج إجباري لمستخدم
async function forceLogoutUser(username) {
  if (username === currentUser) {
    alert("❌ لا يمكنك تسجيل خروج نفسك إجباريًا.");
    return;
  }
  showConfirmModal(`هل تريد تسجيل خروج المستخدم ${username} إجباريًا؟`, async () => {
    try {
      await db.ref("forcedLogout/" + username).set(true);
      alert("✅ تم إرسال أمر تسجيل الخروج الإجباري.");
      logActivity("تسجيل خروج إجباري", username);
    } catch (err) {
      alert("❌ حدث خطأ أثناء تنفيذ تسجيل الخروج الإجباري");
      console.error(err);
    }
  });
}

// تبديل صلاحية التعديل للمستخدم
async function toggleUserEdit(username, currentCanEdit) {
  if (username === currentUser) {
    alert("❌ لا يمكنك تغيير صلاحيتك الخاصة.");
    return;
  }
  await db.ref("users/" + username + "/canEdit").set(!currentCanEdit);
  loadUsers();
}

// حذف مستخدم مع نافذة منبثقة أنيقة وإخراج المستخدم فوراً
async function deleteUser(username) {
  if (username === currentUser) {
    showPermissionRevokedModal("لا يمكن حذف نفسك.");
    return;
  }
  showDeleteUserModal(username);
}

function showDeleteUserModal(username) {
  let oldModal = document.getElementById("deleteUserModal");
  if (oldModal) oldModal.remove();
  const modal = document.createElement("div");
  modal.id = "deleteUserModal";
  modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:9999;display:flex;align-items:center;justify-content:center;`;
  modal.innerHTML = `
    <div style=\"background:linear-gradient(135deg,#fff7f7 60%,#fce4ec 100%);max-width:370px;width:92vw;padding:32px 20px 22px 20px;border-radius:18px;box-shadow:0 8px 32px #e5737333;position:relative;text-align:center;animation:fadeIn 0.3s;\">
      <button id=\"closeDeleteUserModalBtn\" style=\"position:absolute;top:10px;left:10px;background:#e57373;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;transition:background 0.2s;box-shadow:0 2px 8px #e5737322;\">✖</button>
      <div style=\"font-size:21px;color:#d32f2f;margin-bottom:18px;font-weight:700;letter-spacing:0.2px;\">🗑️ حذف مستخدم</div>
      <div style=\"font-size:16.5px;color:#2d3a4a;line-height:1.8;margin-bottom:16px;background:#fff3f3;border-radius:8px;padding:10px 7px 8px 7px;box-shadow:0 1px 4px #e5737311;\">هل أنت متأكد من حذف المستخدم <b style='color:#d32f2f;'>${username}</b>؟<br>سيتم إخراجه فوراً ولن يتمكن من الدخول مجدداً إلا إذا أنشأته من جديد.</div>
      <button id=\"deleteUserConfirmBtn\" style=\"background:linear-gradient(90deg,#d32f2f 60%,#e57373 100%);color:white;padding:11px 0;border:none;border-radius:8px;font-size:17px;cursor:pointer;box-shadow:0 2px 8px #d32f2f22;width:90%;margin-top:8px;font-weight:600;transition:background 0.2s;\">تأكيد الحذف</button>
    </div>
    <style>
      @keyframes fadeIn { from { opacity:0; transform:scale(0.95);} to { opacity:1; transform:scale(1);} }
      @media (max-width: 600px) {
        #deleteUserModal > div { max-width:99vw !important; padding:18px 2vw 18px 2vw !important; }
        #deleteUserModal div { font-size:16px !important; }
      }
      #closeDeleteUserModalBtn:hover { background:#b71c1c !important; }
      #deleteUserConfirmBtn:hover { background:#b71c1c !important; }
    </style>
  `;
  document.body.appendChild(modal);
  document.getElementById("deleteUserConfirmBtn").onclick = async () => {
    await db.ref("users/" + username).remove();
    await db.ref("forcedLogout/" + username).set(true);
    if (username === currentUser) {
      localStorage.setItem('accountDeleted', 'true');
      clearSession && clearSession();
      location.reload();
      return;
    }
    loadUsers();
    logActivity("حذف مستخدم", username);
    modal.remove();
  };
// رسالة حذف الحساب عند تحميل الصفحة
document.addEventListener("DOMContentLoaded", function() {
  if (localStorage.getItem('accountDeleted')) {
    localStorage.removeItem('accountDeleted');
    showAccountDeletedModal();
  }
});

// نافذة رسالة حذف الحساب
function showAccountDeletedModal() {
  const modal = document.createElement("div");
  modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:9999;display:flex;align-items:center;justify-content:center;`;
  modal.innerHTML = `
    <div style="background:#fff3f3;padding:24px 18px;border-radius:12px;box-shadow:0 4px 20px #0002;text-align:center;">
      <div style="font-size:20px;color:#d32f2f;margin-bottom:12px;">❌ تم حذف حسابك</div>
      <div style="font-size:15px;color:#444;">تم حذف حسابك من النظام من قبل المدير.</div>
      <button onclick="this.parentElement.parentElement.remove()" style="margin-top:15px;padding:10px 20px;background:#dc3545;color:#fff;border:none;border-radius:8px;cursor:pointer;">موافق</button>
    </div>
  `;
  document.body.appendChild(modal);
}
// عند تحميل الصفحة، إذا accountDeleted=true في localStorage، أظهر رسالة حذف الحساب فقط
document.addEventListener("DOMContentLoaded", function() {
  if (localStorage.getItem('accountDeleted')) {
    localStorage.removeItem('accountDeleted');
    showAccountDeletedModal();
  }
});
  document.getElementById("closeDeleteUserModalBtn").onclick = () => { modal.remove(); };
}

// تحديث showPermissionRevokedModal لقبول رسالة مخصصة (اختياري)
const _oldShowPermissionRevokedModal = window.showPermissionRevokedModal;
window.showPermissionRevokedModal = function(msg) {
  if (!msg) return _oldShowPermissionRevokedModal();
  let oldModal = document.getElementById("permRevokedModal");
  if (oldModal) oldModal.remove();
  const modal = document.createElement("div");
  modal.id = "permRevokedModal";
  modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:9999;display:flex;align-items:center;justify-content:center;`;
  modal.innerHTML = `
    <div style=\"background:linear-gradient(135deg,#f7faff 60%,#e3eafc 100%);max-width:370px;width:92vw;padding:32px 20px 22px 20px;border-radius:18px;box-shadow:0 8px 32px #1976d233;position:relative;text-align:center;animation:fadeIn 0.3s;\">
      <button id=\"closePermRevokedModalBtn\" style=\"position:absolute;top:10px;left:10px;background:#e57373;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;transition:background 0.2s;box-shadow:0 2px 8px #e5737322;\">✖</button>
      <div style=\"font-size:19px;color:#d32f2f;margin-bottom:16px;font-weight:600;\">${msg}</div>
      <button id=\"permRevokedOkBtn\" style=\"background:linear-gradient(90deg,#1976d2 60%,#42a5f5 100%);color:white;padding:11px 0;border:none;border-radius:8px;font-size:17px;cursor:pointer;box-shadow:0 2px 8px #1976d222;width:90%;margin-top:8px;font-weight:600;transition:background 0.2s;\">حسناً</button>
    </div>
    <style>
      @keyframes fadeIn { from { opacity:0; transform:scale(0.95);} to { opacity:1; transform:scale(1);} }
      @media (max-width: 600px) {
        #permRevokedModal > div { max-width:99vw !important; padding:18px 2vw 18px 2vw !important; }
        #permRevokedModal div { font-size:16px !important; }
      }
      #closePermRevokedModalBtn:hover { background:#b71c1c !important; }
      #permRevokedOkBtn:hover { background:#1565c0 !important; }
    </style>
  `;
  document.body.appendChild(modal);
  document.getElementById("permRevokedOkBtn").onclick = () => { modal.remove(); };
  document.getElementById("closePermRevokedModalBtn").onclick = () => { modal.remove(); };
};

// إضافة مستخدم جديد
async function addUser() {
  const username = document.getElementById("newUserName").value.trim().toLowerCase();
  const password = document.getElementById("newUserPass").value.trim();
  const canEdit = document.getElementById("newUserCanEdit").checked;
  if (!username || !password) {
    alert("❌ يرجى إدخال اسم المستخدم وكلمة المرور");
    return;
  }
  const snapshot = await db.ref("users/" + username).once("value");
  if (snapshot.exists()) {
    alert("❌ اسم المستخدم موجود مسبقاً");
    return;
  }
  try {
    await db.ref("users/" + username).set({ password, role: "user", canEdit });
    alert("✅ تم إنشاء المستخدم بنجاح");
    document.getElementById("newUserName").value = "";
    document.getElementById("newUserPass").value = "";
    document.getElementById("newUserCanEdit").checked = true;
    loadUsers();
  } catch (err) {
    console.error(err);
    alert("❌ حدث خطأ أثناء إنشاء المستخدم");
  }
}

// ========== إدارة الموظفين ==========
function addEmployee() {
  const name = document.getElementById("newEmployeeName").value.trim();
  if (!name) { alert("❌ يرجى إدخال اسم الموظف"); return; }
  if (employees.includes(name)) { alert("❌ الموظف موجود مسبقاً"); return; }
  employees.push(name);
  db.ref("employees").set(employees).then(() => {
    alert("✅ تم إضافة الموظف بنجاح");
    document.getElementById("newEmployeeName").value = "";
    loadEmployeesTable();
    generateTable();
  }).catch(err => {
    console.error(err);
    alert("❌ حدث خطأ أثناء إضافة الموظف");
  });
}
function loadEmployeesTable() {
  const tbody = document.getElementById("employeesBody");
  tbody.innerHTML = "";
  employees.forEach((emp, idx) => {
    const tr = document.createElement("tr");
    const nameTd = document.createElement("td");
    nameTd.textContent = emp;
    nameTd.id = `employeeName_${idx}`;
    const actionsTd = document.createElement("td");
    const editBtn = document.createElement("button");
    editBtn.textContent = "✏️ تعديل";
    editBtn.className = "small-button btn-edit";
    editBtn.onclick = () => enableEmployeeEdit(idx);
    const deleteBtn = document.createElement("button");
    deleteBtn.textContent = "حذف";
    deleteBtn.className = "small-button btn-delete";
    deleteBtn.onclick = () => deleteEmployee(idx);
    actionsTd.appendChild(editBtn);
    actionsTd.appendChild(deleteBtn);
    tr.appendChild(nameTd);
    tr.appendChild(actionsTd);
    tbody.appendChild(tr);
  });
}
function enableEmployeeEdit(index) {
  const nameTd = document.getElementById(`employeeName_${index}`);
  const oldName = nameTd.textContent;
  nameTd.innerHTML = "";
  const input = document.createElement("input");
  input.type = "text";
  input.value = oldName;
  input.style.width = "80%";
  nameTd.appendChild(input);
  const saveBtn = document.createElement("button");
  saveBtn.textContent = "💾 حفظ";
  saveBtn.className = "small-button btn-edit";
  saveBtn.style.marginLeft = "5px";
  saveBtn.onclick = () => {
    const newName = input.value.trim();
    if (!newName) { alert("❌ اسم الموظف لا يمكن أن يكون فارغاً"); return; }
    if (employees.includes(newName)) { alert("❌ اسم الموظف موجود مسبقاً"); return; }
    // نقل بيانات الحضور من الاسم القديم إلى الاسم الجديد
    db.ref("attendance").once("value").then(snapshot => {
      const attendance = snapshot.val() || {};
      Object.keys(attendance).forEach(dayKey => {
        if (attendance[dayKey][oldName] !== undefined) {
          attendance[dayKey][newName] = attendance[dayKey][oldName];
          delete attendance[dayKey][oldName];
        }
      });
      employees[index] = newName;
      // حفظ التغييرات في الموظفين والحضور
      return Promise.all([
        db.ref("employees").set(employees),
        db.ref("attendance").set(attendance)
      ]);
    }).then(() => {
      alert("✅ تم تعديل اسم الموظف ونقل جميع بيانات حضوره بنجاح");
      loadEmployeesTable();
      generateTable();
    }).catch(err => {
      console.error(err);
      alert("❌ حدث خطأ أثناء تعديل اسم الموظف");
    });
  };
  nameTd.appendChild(saveBtn);
}

// ========== PDF ==========
async function downloadPDF() {
  const element = document.getElementById('attendanceTable');
  const canvas = await html2canvas(element, {scale:2});
  const imgData = canvas.toDataURL('image/png');
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('l', 'pt', 'a4');
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();
  const imgProps = pdf.getImageProperties(imgData);
  const ratio = Math.min(pageWidth / imgProps.width, pageHeight / imgProps.height);
  const imgWidth = imgProps.width * ratio;
  const imgHeight = imgProps.height * ratio;
  pdf.addImage(imgData, 'PNG', (pageWidth - imgWidth)/2, 20, imgWidth, imgHeight);
  pdf.save('attendance.pdf');
}

// ========== إحصائيات ==========
function calculateStats(savedData) {
  const counts = {};
  employees.forEach(e=>{ counts[e]={"شفت":0,"نص":0,"❌":0}; });
  Object.values(savedData).forEach(day=>{
    employees.forEach(e=>{
      const val = day[e];
      if (val && counts[e][val] !== undefined) counts[e][val] += 1;
    });
  });
  const bestShift = Object.entries(counts).sort((a,b)=>b[1]["شفت"]-a[1]["شفت"])[0];
  const bestHalf  = Object.entries(counts).sort((a,b)=>b[1]["نص"]-a[1]["نص"])[0];
  const mostX     = Object.entries(counts).sort((a,b)=>b[1]["❌"]-a[1]["❌"])[0];
  const statsDiv = document.getElementById('statsBox');
  statsDiv.innerHTML = `
    <p>أكثر موظف شفت: <b>${bestShift ? bestShift[0]+` (${bestShift[1]["شفت"]})` : '—'}</b></p>
    <p>أكثر موظف نص: <b>${bestHalf ? bestHalf[0]+` (${bestHalf[1]["نص"]})` : '—'}</b></p>
    <p>أكثر موظف ❌: <b>${mostX ? mostX[0]+` (${mostX[1]["❌"]})` : '—'}</b></p>`;
}

// ========== Tabs للأشهر ==========

// زر عائم للأشهر بشكل دائري حديث
const monthsFab = document.createElement("div");
monthsFab.id = "monthsFab";
monthsFab.innerHTML = `<button id="fabMainMonth" class="fab-month"></button><div id="fabMonthsList" style="display:none;"></div>`;
monthsFab.style.position = "fixed";
monthsFab.style.bottom = "22px";
monthsFab.style.left = "22px";
monthsFab.style.zIndex = "9999";
document.body.appendChild(monthsFab);

function loadAvailableMonths() {
  db.ref("attendance").once("value").then(snapshot => {
    const data = snapshot.val() || {};
    const monthsSet = new Set();
    Object.keys(data).forEach(key => {
      const parts = key.split("-");
      if (parts.length === 3) {
        const m = parseInt(parts[1]) - 1;
        monthsSet.add(m);
      }
    });
    const monthsArr = Array.from(monthsSet).sort((a,b)=>a-b);
    renderMonthFab(monthsArr);
  });
}

function renderMonthFab(months) {
  const fabBtn = document.getElementById("fabMainMonth");
  const fabList = document.getElementById("fabMonthsList");
  fabBtn.textContent = "📅";
  fabBtn.title = `تغيير الشهر`;
  fabBtn.style.background = "#007bff";
  fabBtn.style.color = "white";
  fabBtn.style.fontWeight = "bold";
  fabBtn.style.fontSize = "20px";
  fabBtn.style.boxShadow = "0 2px 8px #007bff44";
  fabBtn.style.transition = "box-shadow 0.2s";
  fabBtn.onmouseenter = ()=>fabBtn.style.boxShadow = "0 4px 16px #007bff77";
  fabBtn.onmouseleave = ()=>fabBtn.style.boxShadow = "0 2px 8px #007bff44";
  fabBtn.onclick = function() {
    fabList.style.display = fabList.style.display === "none" ? "flex" : "none";
  };
  fabList.innerHTML = "";
  fabList.style.position = "absolute";
  fabList.style.bottom = "60px";
  fabList.style.left = "0";
  fabList.style.flexDirection = "column";
  fabList.style.gap = "8px";
  fabList.style.alignItems = "flex-start";
  fabList.style.transition = "all 0.2s";
  months.slice().reverse().forEach(m => {
    const btn = document.createElement("button");
    btn.textContent = (m+1);
    btn.className = "fab-month fab-month-mini";
    btn.style.background = m === month ? "#007bff" : "#f4f4f4";
    btn.style.color = m === month ? "white" : "#333";
    btn.title = arMonths[m];
    btn.onclick = function() {
      month = m;
      generateTable();
      renderMonthFab(months);
      fabList.style.display = "none";
    };
    fabList.appendChild(btn);
  });
}

// CSS للأزرار العائمة
const fabStyle = document.createElement("style");
fabStyle.innerHTML = `
  .fab-month {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: none;
    outline: none;
    box-shadow: 0 2px 8px #007bff44;
    background: #007bff;
    color: white;
    font-size: 20px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 0;
    transition: box-shadow 0.2s, background 0.2s, color 0.2s;
  }
  .fab-month-mini {
    width: 32px;
    height: 32px;
    font-size: 15px;
    margin-bottom: 2px;
    background: #f4f4f4;
    color: #333;
    border: 2px solid #007bff22;
  }
  .fab-month-mini:hover {
    background: #007bff;
    color: white;
    border: 2px solid #007bff;
  }
`;
document.head.appendChild(fabStyle);
if (localStorage.getItem('loggedUser')) { loadAvailableMonths(); }

// ========== زر فتح/إغلاق لوحة التحكم ==========
const toggleAdminBtn = document.createElement("button");
toggleAdminBtn.id = "toggleAdminBtn";
toggleAdminBtn.textContent = "⚙️ لوحة التحكم";
toggleAdminBtn.style.backgroundColor = "#6c757d";
toggleAdminBtn.style.color = "white";
toggleAdminBtn.style.border = "none";
toggleAdminBtn.style.width = "100%";
toggleAdminBtn.style.padding = "10px";
toggleAdminBtn.style.marginTop = "15px";
toggleAdminBtn.style.fontSize = "16px";
toggleAdminBtn.style.borderRadius = "5px";
toggleAdminBtn.style.cursor = "pointer";
toggleAdminBtn.style.transition = "background 0.2s ease";
toggleAdminBtn.onmouseover = () => { toggleAdminBtn.style.backgroundColor = "#5a6268"; };
toggleAdminBtn.onmouseout = () => {
  if (adminPanel.style.maxHeight === "0px") toggleAdminBtn.style.backgroundColor = "#6c757d";
};
const logoutBtn = document.querySelector("button[onclick='logout()']");
logoutBtn.parentNode.insertBefore(toggleAdminBtn, logoutBtn);
const adminPanel = document.getElementById("adminPanel");
adminPanel.style.maxHeight = "0px";
adminPanel.style.overflow = "hidden";
adminPanel.style.transition = "max-height 0.4s ease";
toggleAdminBtn.onclick = () => {
  if (adminPanel.style.maxHeight === "0px") {
    adminPanel.style.maxHeight = adminPanel.scrollHeight + "px";
    toggleAdminBtn.style.backgroundColor = "green";
    setTimeout(() => {
      adminPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 200);
  } else {
    adminPanel.style.maxHeight = "0px";
    toggleAdminBtn.style.backgroundColor = "#6c757d";
  }
};

// ========== حذف متقدم ==========
function advancedDelete() {
  // نافذة اختيار العملية بشكل أزرار واضحة
  let modal = document.getElementById("deleteChoiceModal");
  if (modal) modal.remove();
  modal = document.createElement("div");
  modal.id = "deleteChoiceModal";
  modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:9999;display:flex;align-items:center;justify-content:center;`;
  modal.innerHTML = `
    <div style=\"background:#fff;max-width:370px;width:92vw;padding:26px 18px 20px 18px;border-radius:16px;box-shadow:0 8px 32px #0002;position:relative;text-align:center;animation:fadeIn 0.3s;\">
      <button id=\"closeDeleteChoiceModalBtn\" style=\"position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;transition:background 0.2s;\">✖</button>
      <div style=\"font-size:18px;color:#333;margin-bottom:20px;font-weight:500;\">اختر العملية التي تريد تنفيذها:</div>
      <div style=\"display:flex;flex-direction:column;gap:10px;align-items:center;\">
        <button class=\"deleteOpBtn\" data-op=\"1\" style=\"background:#e91e63;color:white;padding:10px 22px;border:none;border-radius:7px;font-size:16px;cursor:pointer;\">1 - حذف الموظفين فقط</button>
        <button class=\"deleteOpBtn\" data-op=\"2\" style=\"background:#9c27b0;color:white;padding:10px 22px;border:none;border-radius:7px;font-size:16px;cursor:pointer;\">2 - حذف حسابات المستخدمين</button>
        <button class=\"deleteOpBtn\" data-op=\"3\" style=\"background:#ff9800;color:white;padding:10px 22px;border:none;border-radius:7px;font-size:16px;cursor:pointer;\">3 - حذف التاشيرات (شفت، نص، ❌)</button>
        <button class=\"deleteOpBtn\" data-op=\"4\" style=\"background:#009688;color:white;padding:10px 22px;border:none;border-radius:7px;font-size:16px;cursor:pointer;\">4 - حذف سجل النشاطات</button>
        <button class=\"deleteOpBtn\" data-op=\"5\" style=\"background:#607d8b;color:white;padding:10px 22px;border:none;border-radius:7px;font-size:16px;cursor:pointer;\">5 - حذف كل البيانات</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  document.getElementById("closeDeleteChoiceModalBtn").onclick = function() { modal.remove(); };
  Array.from(document.getElementsByClassName("deleteOpBtn")).forEach(btn => {
    btn.onclick = function() {
      const choice = btn.getAttribute("data-op");
      modal.remove();
      // نافذة إدخال كلمة مرور المدير
      let passModal = document.getElementById("adminPassModal");
      if (passModal) passModal.remove();
      passModal = document.createElement("div");
      passModal.id = "adminPassModal";
      passModal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:9999;display:flex;align-items:center;justify-content:center;`;
      passModal.innerHTML = `
        <div style=\"background:#fff;max-width:350px;width:90vw;padding:22px 18px 18px 18px;border-radius:14px;box-shadow:0 8px 32px #0002;position:relative;text-align:center;\">
          <button id=\"closeAdminPassModalBtn\" style=\"position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;\">✖</button>
          <div style=\"font-size:17px;color:#333;margin-bottom:18px;\">يرجى إدخال كلمة مرور المدير للتأكيد:</div>
          <input id=\"adminPassInput\" type=\"password\" style=\"width:90%;padding:8px 10px;font-size:16px;border-radius:6px;border:1px solid #ccc;margin-bottom:14px;\" />
          <button id=\"adminPassConfirmBtn\" style=\"background:#007bff;color:white;padding:8px 18px;border:none;border-radius:6px;font-size:16px;cursor:pointer;\">تأكيد</button>
        </div>
      `;
      document.body.appendChild(passModal);
      document.getElementById("adminPassConfirmBtn").onclick = function() {
        const adminPass = document.getElementById("adminPassInput").value;
        passModal.remove();
        db.ref("users/admin/password").once("value").then(snapshot => {
          const realAdminPass = snapshot.val();
          if (adminPass !== realAdminPass) {
            alert("❌ كلمة المرور غير صحيحة!");
            return;
          }
          // نافذة تأكيد نهائي
          showConfirmModal("هل أنت متأكد من تنفيذ هذا الإجراء؟ لا يمكن التراجع عنه!", () => {
            switch(choice) {
              case "1":
                db.ref("employees").remove()
                  .then(() => alert("✅ تم حذف الموظفين فقط."))
                  .catch(e => alert("❌ خطأ في حذف الموظفين: " + e.message));
                break;
              case "2":
                db.ref("users").remove()
                  .then(() => alert("✅ تم حذف حسابات المستخدمين."))
                  .catch(e => alert("❌ خطأ في حذف حسابات المستخدمين: " + e.message));
                break;
              case "3":
                db.ref("attendance").remove()
                  .then(() => alert("✅ تم حذف التاشيرات."))
                  .catch(e => alert("❌ خطأ في حذف التاشيرات: " + e.message));
                break;
              case "4":
                db.ref("activityLog").remove()
                  .then(() => alert("✅ تم حذف سجل النشاطات."))
                  .catch(e => alert("❌ خطأ في حذف سجل النشاطات: " + e.message));
                break;
              case "5":
                Promise.all([
                  db.ref("employees").remove(),
                  db.ref("attendance").remove(),
                  db.ref("activityLog").remove(),
                  db.ref("users").once("value").then(snapshot => {
                    const users = snapshot.val() || {};
                    const updates = {};
                    Object.keys(users).forEach(username => {
                      if (username !== currentUser) updates[username] = null;
                    });
                    return db.ref("users").update(updates);
                  })
                ]).then(() => {
                  alert("✅ تم حذف كل البيانات ما عدا حسابك الحالي.");
                }).catch(e => {
                  alert("❌ خطأ في حذف البيانات: " + e.message);
                });
                break;
            }
          });
        });
      };
      document.getElementById("closeAdminPassModalBtn").onclick = function() { passModal.remove(); };
    };
  });
}
document.addEventListener("DOMContentLoaded", () => {
  const btnDeleteData = document.getElementById("btnDeleteData");
  if (btnDeleteData) btnDeleteData.addEventListener("click", advancedDelete);
});

// ========== طرد المستخدم ==========
function checkForcedLogoutOnLogin(userKey) {
  return db.ref("forcedLogout/" + userKey).once("value").then(snapshot => {
    if (snapshot.exists()) {
      localStorage.removeItem('loggedUser');
      db.ref("users/" + userKey).once("value").then(userSnap => {
        if (!userSnap.exists()) {
          showAccountDeletedModal();
        } else {
          showForcedLogoutModal();
        }
      });
      db.ref("forcedLogout/" + userKey).remove();
      setTimeout(()=>location.reload(), 2500);
      return true;
    }
    return false;
  });
}

// نافذة أنيقة عند حذف حساب المستخدم من قبل المدير
function showAccountDeletedModal() {
  let oldModal = document.getElementById("accountDeletedModal");
  if (oldModal) oldModal.remove();
  const modal = document.createElement("div");
  modal.id = "accountDeletedModal";
  modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:9999;display:flex;align-items:center;justify-content:center;`;
  modal.innerHTML = `
    <div style=\"background:linear-gradient(135deg,#fff7f7 60%,#fce4ec 100%);max-width:370px;width:92vw;padding:32px 20px 22px 20px;border-radius:18px;box-shadow:0 8px 32px #e5737333;position:relative;text-align:center;animation:fadeIn 0.3s;\">
      <div style=\"font-size:21px;color:#d32f2f;margin-bottom:18px;font-weight:700;letter-spacing:0.2px;\">🚫 تم حذف حسابك</div>
      <div style=\"font-size:16.5px;color:#2d3a4a;line-height:1.8;margin-bottom:16px;background:#fff3f3;border-radius:8px;padding:10px 7px 8px 7px;box-shadow:0 1px 4px #e5737311;\">تم حذف حسابك من قبل المدير.<br>لن تتمكن من الدخول إلا إذا تم إنشاؤه من جديد.</div>
    </div>
    <style>
      @keyframes fadeIn { from { opacity:0; transform:scale(0.95);} to { opacity:1; transform:scale(1);} }
      @media (max-width: 600px) {
        #accountDeletedModal > div { max-width:99vw !important; padding:18px 2vw 18px 2vw !important; }
        #accountDeletedModal div { font-size:16px !important; }
      }
    </style>
  `;
  document.body.appendChild(modal);
}

// نافذة أنيقة عند تسجيل خروج المستخدم إجباريًا (احتياط)
function showForcedLogoutModal() {
  let oldModal = document.getElementById("forcedLogoutModal");
  if (oldModal) oldModal.remove();
  const modal = document.createElement("div");
  modal.id = "forcedLogoutModal";
  modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:9999;display:flex;align-items:center;justify-content:center;`;
  modal.innerHTML = `
    <div style=\"background:linear-gradient(135deg,#f7faff 60%,#e3eafc 100%);max-width:370px;width:92vw;padding:32px 20px 22px 20px;border-radius:18px;box-shadow:0 8px 32px #1976d233;position:relative;text-align:center;animation:fadeIn 0.3s;\">
      <div style=\"font-size:21px;color:#1976d2;margin-bottom:18px;font-weight:700;letter-spacing:0.2px;\">🚪 تم تسجيل خروجك</div>
      <div style=\"font-size:16.5px;color:#2d3a4a;line-height:1.8;margin-bottom:16px;background:#f3f7ff;border-radius:8px;padding:10px 7px 8px 7px;box-shadow:0 1px 4px #1976d211;\">تم تسجيل خروجك من قبل المدير.<br>لن تتمكن من استخدام النظام حتى تعيد تسجيل الدخول.</div>
    </div>
    <style>
      @keyframes fadeIn { from { opacity:0; transform:scale(0.95);} to { opacity:1; transform:scale(1);} }
      @media (max-width: 600px) {
        #forcedLogoutModal > div { max-width:99vw !important; padding:18px 2vw 18px 2vw !important; }
        #forcedLogoutModal div { font-size:16px !important; }
      }
    </style>
  `;
  document.body.appendChild(modal);
}
if (localStorage.getItem('loggedUser')) {
  const savedUser = JSON.parse(localStorage.getItem('loggedUser'));
  checkForcedLogoutOnLogin(savedUser.user);
}
setInterval(() => {
  if (currentUser) {
    db.ref("forcedLogout/" + currentUser).once("value").then(snapshot => {
      if (snapshot.exists()) {
        localStorage.removeItem('loggedUser');
        showForcedLogoutModal();
        db.ref("forcedLogout/" + currentUser).remove();
        setTimeout(()=>location.reload(), 2500);
      }
    });
  }
}, 3000);

// ========== إحصائيات الموظفين للمستخدمين ==========
function setEmpStatsEnabled(enabled) {
  db.ref("settings/showEmpStats").set(enabled ? true : false);
}
function getEmpStatsEnabled() {
  return db.ref("settings/showEmpStats").once("value").then(snap => !!snap.val());
}
function setEmpStatsMode(mode, value) {
  db.ref("settings/empStatsMode").set({mode, value: value || ""});
}
function getEmpStatsMode() {
  return db.ref("settings/empStatsMode").once("value").then(snap => snap.val() || {mode:"all",value:""});
}
const toggleEmpStatsBtn = document.getElementById("toggleEmpStatsBtn");
const empStatsTab = document.getElementById("empStatsTab");
const empStatsTabContent = document.getElementById("empStatsTabContent");
const closeEmpStatsTab = document.getElementById("closeEmpStatsTab");
if (closeEmpStatsTab) {
  closeEmpStatsTab.onclick = () => { empStatsTab.style.display = "none"; };
}
function openEmpStatsTab(html) {
  empStatsTabContent.innerHTML = html;
  empStatsTab.style.display = "flex";
}
if (toggleEmpStatsBtn) {
  toggleEmpStatsBtn.onclick = function() {
    let html = `
      <div style="margin-bottom:18px;">
        <b>التحكم في عرض الإحصائيات للمستخدمين:</b>
        <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;justify-content:center;">
          <button id="showAllStatsBtn" class="small-button" style="background:#28a745;color:white;min-width:110px;">عرض للجميع</button>
          <button id="showUserStatsBtn" class="small-button" style="background:#007bff;color:white;min-width:110px;">عرض لمستخدم معين</button>
          <button id="showEmpStatsBtn" class="small-button" style="background:#ffc107;color:black;min-width:110px;">عرض لموظف معين فقط</button>
        </div>
      </div>
      <div id="empStatsAdminOptions" style="margin-bottom:20px;"></div>
      <div style="border-top:1px solid #eee;margin:10px 0 15px 0;"></div>
      <div>
        <b>إحصائيات الموظفين:</b>
        <div id="empStatsTabGrid" style="margin-top:15px;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:15px;"></div>
      </div>
      <style>
        @media (max-width:600px){
          #empStatsTabGrid{grid-template-columns:1fr;gap:10px;}
        }
        .emp-card{background:#f8f9fa;border-radius:10px;box-shadow:0 1px 6px #0001;padding:16px 12px;display:flex;flex-direction:column;align-items:center;transition:box-shadow 0.2s;}
        .emp-card:hover{box-shadow:0 4px 16px #0002;}
        .emp-card .emp-name{font-weight:bold;font-size:17px;color:#007bff;margin-bottom:8px;}
        .emp-card .emp-stats{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;}
        .emp-card .stat{display:flex;align-items:center;gap:4px;font-size:15px;background:#fff;border-radius:6px;padding:5px 10px;margin:3px 0;box-shadow:0 1px 3px #0001;}
        .emp-card .stat.shift{color:#28a745;}
        .emp-card .stat.half{color:#ffc107;}
        .emp-card .stat.absent{color:#dc3545;}
      </style>
    `;
    openEmpStatsTab(html);
    const gridDiv = document.getElementById("empStatsTabGrid");
    gridDiv.innerHTML = "<div style='text-align:center;width:100%;color:#888;'>جاري التحميل...</div>";
    db.ref("attendance").once("value").then(snapshot => {
      const data = snapshot.val() || {};
      gridDiv.innerHTML = "";
      employees.forEach(emp => {
        let shift=0, half=0, x=0;
        Object.values(data).forEach(day => {
          if (day[emp] === "شفت") shift++;
          if (day[emp] === "نص") half++;
          if (day[emp] === "❌") x++;
        });
        const card = document.createElement("div");
        card.className = "emp-card";
        card.innerHTML = `
          <div class='emp-name'>${emp}</div>
          <div class='emp-stats'>
            <div class='stat shift'>✅ شفت: <b>${shift}</b></div>
            <div class='stat half'>🌓 نص: <b>${half}</b></div>
            <div class='stat absent'>🏖️ اجازة: <b>${x}</b></div>
          </div>
        `;
        gridDiv.appendChild(card);
      });
    });
    document.getElementById("showAllStatsBtn").onclick = function() {
      setEmpStatsEnabled(true);
      setEmpStatsMode("all", "");
      document.getElementById("empStatsAdminOptions").innerHTML = "<span style='color:green'>سيتم عرض الإحصائيات لكل المستخدمين</span>";
    };
    document.getElementById("showUserStatsBtn").onclick = function() {
      db.ref("users").once("value").then(snapshot => {
        const users = snapshot.val() || {};
        let html = "<b>اختر مستخدم:</b><br>";
        Object.keys(users).forEach(u => {
          html += `<button class=\"small-button\" style=\"margin:3px 2px;background:#007bff;color:white;\" onclick=\"window.setEmpStatsModeForUser('${u}')\">${u}</button>`;
        });
        document.getElementById("empStatsAdminOptions").innerHTML = html;
      });
    };
    document.getElementById("showEmpStatsBtn").onclick = function() {
      let html = "<b>اختر موظف:</b><br>";
      employees.forEach(emp => {
        html += `<button class=\"small-button\" style=\"margin:3px 2px;background:#ffc107;color:black;\" onclick=\"window.setEmpStatsModeForEmp('${emp}')\">${emp}</button>`;
      });
      document.getElementById("empStatsAdminOptions").innerHTML = html;
    };
    window.setEmpStatsModeForUser = function(username) {
      setEmpStatsEnabled(true);
      setEmpStatsMode("user", username);
      document.getElementById("empStatsAdminOptions").innerHTML = `<span style='color:green'>سيتم عرض الإحصائيات فقط للمستخدم: <b>${username}</b></span>`;
    };
    window.setEmpStatsModeForEmp = function(emp) {
      setEmpStatsEnabled(true);
      setEmpStatsMode("employee", emp);
      document.getElementById("empStatsAdminOptions").innerHTML = `<span style='color:green'>سيتم عرض إحصائيات الموظف <b>${emp}</b> فقط لكل المستخدمين</span>`;
    };
    getEmpStatsMode().then(modeObj => {
      let txt = "";
      if (modeObj.mode === "all") txt = "<span style='color:green'>سيتم عرض الإحصائيات لكل المستخدمين</span>";
      else if (modeObj.mode === "user") txt = `<span style='color:green'>سيتم عرض الإحصائيات فقط للمستخدم: <b>${modeObj.value}</b></span>`;
      else if (modeObj.mode === "employee") txt = `<span style='color:green'>سيتم عرض إحصائيات الموظف <b>${modeObj.value}</b> فقط لكل المستخدمين</span>`;
      document.getElementById("empStatsAdminOptions").innerHTML = txt;
    });
  };
}

// ========== إحصائيات للمستخدمين ==========
const userEmpStatsDiv = document.createElement("div");
userEmpStatsDiv.id = "userEmpStatsDiv";
userEmpStatsDiv.style.margin = "20px 0";
userEmpStatsDiv.style.padding = "10px";
userEmpStatsDiv.style.background = "#f8f9fa";
userEmpStatsDiv.style.border = "1px solid #ddd";
userEmpStatsDiv.style.borderRadius = "7px";
userEmpStatsDiv.style.display = "none";
document.getElementById("mainContent").appendChild(userEmpStatsDiv);

function renderUserEmpStats() {
  Promise.all([getEmpStatsEnabled(), getEmpStatsMode()]).then(([enabled, modeObj]) => {
    if (!enabled) {
      userEmpStatsDiv.style.display = "none";
      return;
    }
    let allow = false, onlyEmp = null;
    if (modeObj.mode === "all") allow = true;
    else if (modeObj.mode === "user" && currentUser === modeObj.value) allow = true;
    else if (modeObj.mode === "employee") { allow = true; onlyEmp = modeObj.value; }
    if (!allow) { userEmpStatsDiv.style.display = "none"; return; }
    let html = `
      <b>إحصائيات الموظفين:</b>
      <div id='userEmpStatsGrid' style='margin-top:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:13px;'></div>
      <style>
        @media (max-width:600px){
          #userEmpStatsGrid{grid-template-columns:1fr;gap:8px;}
        }
        .emp-card{background:#f8f9fa;border-radius:10px;box-shadow:0 1px 6px #0001;padding:15px 10px;display:flex;flex-direction:column;align-items:center;transition:box-shadow 0.2s;}
        .emp-card .emp-name{font-weight:bold;font-size:16px;color:#007bff;margin-bottom:7px;}
        .emp-card .emp-stats{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;}
        .emp-card .stat{display:flex;align-items:center;gap:4px;font-size:14px;background:#fff;border-radius:6px;padding:4px 9px;margin:2px 0;box-shadow:0 1px 3px #0001;}
        .emp-card .stat.shift{color:#28a745;}
        .emp-card .stat.half{color:#ffc107;}
        .emp-card .stat.absent{color:#dc3545;}
      </style>
    `;
    userEmpStatsDiv.innerHTML = html;
    const gridDiv = document.getElementById("userEmpStatsGrid");
    gridDiv.innerHTML = "<div style='text-align:center;width:100%;color:#888;'>جاري التحميل...</div>";
    db.ref("attendance").once("value").then(snapshot => {
      const data = snapshot.val() || {};
      gridDiv.innerHTML = "";
      employees.forEach(emp => {
        if (onlyEmp && emp !== onlyEmp) return;
        let shift=0, half=0, x=0;
        Object.values(data).forEach(day => {
          if (day[emp] === "شفت") shift++;
          if (day[emp] === "نص") half++;
          if (day[emp] === "❌") x++;
        });
        const salary = (shift * 20000) + (half * 10000);
        const card = document.createElement("div");
        card.className = "emp-card";
        card.innerHTML = `
          <div class='emp-name'>${emp}</div>
          <div class='emp-stats'>
            <div class='stat shift'>✅ شفت: <b>${shift}</b></div>
            <div class='stat half'>🌓 نص: <b>${half}</b></div>
            <div class='stat absent'>🏖️ اجازة: <b>${x}</b></div>
          </div>
          <div class='emp-salary' style='margin-top:8px;font-size:15px;color:#222;background:#e3f7e3;padding:6px 0;border-radius:7px;width:100%;text-align:center;'>
            💰 الراتب الكلي: <b>${salary.toLocaleString()} د.ع</b>
          </div>
        `;
        gridDiv.appendChild(card);
      });
    });
    userEmpStatsDiv.style.display = "block";
  });
}
function tryShowUserEmpStats() {
  if (typeof employees !== "undefined" && employees.length > 0) renderUserEmpStats();
}
const origLoadEmployees = loadEmployees;
loadEmployees = function() {
  return origLoadEmployees.apply(this, arguments).then(() => {
    tryShowUserEmpStats();
  });
};
if (localStorage.getItem('loggedUser')) tryShowUserEmpStats();
db.ref("settings/empStatsMode").on("value", () => renderUserEmpStats());

// ========== تغيير كلمة مرور المدير ==========
// تعديل: السماح فقط للمدير بتغيير كلمة المرور
function changeAdminPassword() {
  const oldPass = document.getElementById("adminOldPass").value;
  const newPass = document.getElementById("adminNewPass").value;
  const statusDiv = document.getElementById("adminPassStatus");
  if (currentUserRole !== "admin") {
    statusDiv.textContent = "❌ فقط المدير يمكنه تغيير كلمة المرور.";
    return;
  }
  if (!oldPass || !newPass) {
    statusDiv.textContent = "يرجى إدخال جميع الحقول.";
    return;
  }
  db.ref("users/admin/password").once("value").then(snapshot => {
    if (!snapshot.exists() || snapshot.val() !== oldPass) {
      statusDiv.textContent = "كلمة المرور الحالية غير صحيحة.";
      return;
    }
    db.ref("users/admin/password").set(newPass).then(() => {
      statusDiv.textContent = "✅ تم تغيير كلمة المرور بنجاح.";
      document.getElementById("adminOldPass").value = "";
      document.getElementById("adminNewPass").value = "";
      logActivity("تغيير كلمة مرور المدير", `تم تغيير كلمة المرور من قبل: ${currentUser}`);
    });
  }).catch(() => {
    statusDiv.textContent = "❌ حدث خطأ أثناء تغيير كلمة المرور.";
  });
}

// ========== حذف موظف ==========
// تعديل: السماح فقط للمدير بالحذف والتحقق من وجود الموظف
function deleteEmployee(index) {
  if (currentUserRole !== "admin") {
    alert("❌ فقط المدير يمكنه حذف الموظفين.");
    return;
  }
  const empName = employees[index];
  if (!empName) {
    alert("❌ الموظف غير موجود.");
    return;
  }
  showConfirmModal(`هل أنت متأكد من حذف الموظف "${empName}"؟ سيتم حذف جميع بيانات حضوره أيضا.`, () => {
    employees.splice(index, 1);
    db.ref("employees").set(employees)
      .then(() => {
        db.ref("attendance").once("value").then(snapshot => {
          const attendance = snapshot.val() || {};
          Object.keys(attendance).forEach(dayKey => {
            if (attendance[dayKey][empName] !== undefined) {
              delete attendance[dayKey][empName];
            }
          });
          return db.ref("attendance").set(attendance);
        }).then(() => {
          alert("✅ تم حذف الموظف وجميع بيانات حضوره بنجاح.");
          loadEmployeesTable();
          generateTable();
          logActivity("حذف موظف", `تم حذف الموظف: ${empName} وجميع بيانات حضوره`);
        });
      })
      .catch(err => {
        console.error(err);
        alert("❌ حدث خطأ أثناء حذف الموظف.");
      });
  });
}

// ========== نسخ احتياطي للبيانات ==========
// تعديل: التعامل مع الأخطاء بشكل أفضل
function backupData() {
  document.getElementById("backupStatus").textContent = "جاري تجهيز النسخة...";
  Promise.all([
    db.ref("employees").once("value"),
    db.ref("attendance").once("value"),
    db.ref("users").once("value")
  ]).then(([empSnap, attSnap, usersSnap]) => {
    const data = {
      employees: empSnap.val() || {},
      attendance: attSnap.val() || {},
      users: usersSnap.val() || {}
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "backup-" + new Date().toISOString().slice(0,10) + ".json";
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); }, 500);
    document.getElementById("backupStatus").textContent = "✅ تم تحميل النسخة الاحتياطية.";
    logActivity("تحميل نسخة احتياطية", "تم تحميل نسخة احتياطية من البيانات");
  }).catch((err) => {
    document.getElementById("backupStatus").textContent = "❌ حدث خطأ أثناء النسخ الاحتياطي.";
    console.error("Backup error:", err);
  });
}
</script>

<!-- إضافة: نافذة تغيير كلمة المرور -->
<div id="changePassModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:6000;align-items:center;justify-content:center;">
  <div style="background:#fff;max-width:340px;width:95vw;border-radius:12px;box-shadow:0 8px 32px #0002;padding:22px 18px 18px 18px;position:relative;">
    <button id="closeChangePassModal" style="position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:28px;height:28px;font-size:16px;cursor:pointer;">✖</button>
    <h3 style="text-align:center;margin-bottom:18px;color:#2196f3;">🔑 تغيير كلمة المرور</h3>
    <div id="changePassForm"></div>
    <div id="changePassStatus" style="margin-top:10px;font-size:14px;text-align:center;"></div>
  </div>
</div>
<script>
// فتح نافذة تغيير كلمة المرور
document.getElementById("sidebarChangePassBtn").onclick = function() {
  document.getElementById("sidebarMenu").classList.remove("open");
  showChangePassForm();
};

function showChangePassForm() {
  const modal = document.getElementById("changePassModal");
  const formDiv = document.getElementById("changePassForm");
  const statusDiv = document.getElementById("changePassStatus");
  statusDiv.textContent = "";
  // إذا المدير، يمكنه اختيار أي مستخدم أو نفسه
  if (currentUserRole === "admin") {
    db.ref("users").once("value").then(snapshot => {
      const users = snapshot.val() || {};
      let html = `<label>اختر المستخدم:</label>
        <select id="changePassUser" style="width:100%;margin-bottom:10px;">`;
      Object.keys(users).forEach(u => {
        html += `<option value="${u}" ${u===currentUser?'selected':''}>${u}${u==='admin'?' (مدير)':''}</option>`;
      });
      html += `</select>
        <input type="password" id="changePassOld" placeholder="كلمة المرور الحالية" style="margin-bottom:8px;" />
        <input type="password" id="changePassNew" placeholder="كلمة المرور الجديدة" style="margin-bottom:8px;" />
        <button id="changePassSubmit" style="background:#2196f3;color:white;width:100%;margin-top:8px;">تغيير كلمة المرور</button>`;
      formDiv.innerHTML = html;
      modal.style.display = "flex";
      document.getElementById("changePassSubmit").onclick = function() {
        const user = document.getElementById("changePassUser").value;
        const oldPass = document.getElementById("changePassOld").value;
        const newPass = document.getElementById("changePassNew").value;
        if (!oldPass || !newPass) return statusDiv.textContent = "يرجى إدخال جميع الحقول.";
        db.ref("users/" + user + "/password").once("value").then(snapshot => {
          if (!snapshot.exists() || snapshot.val() !== oldPass) return statusDiv.textContent = "كلمة المرور الحالية غير صحيحة.";
          db.ref("users/" + user + "/password").set(newPass).then(() => {
            statusDiv.textContent = "✅ تم تغيير كلمة المرور بنجاح.";
            logActivity("تغيير كلمة مرور", `تم تغيير كلمة المرور للمستخدم: ${user} بواسطة: ${currentUser}`);
            document.getElementById("changePassOld").value = "";
            document.getElementById("changePassNew").value = "";
          });
        });
      };
    });
  } else {
    let html = `
      <input type="password" id="changePassOld" placeholder="كلمة المرور الحالية" style="margin-bottom:8px;" />
      <input type="password" id="changePassNew" placeholder="كلمة المرور الجديدة" style="margin-bottom:8px;" />
      <button id="changePassSubmit" style="background:#2196f3;color:white;width:100%;margin-top:8px;">تغيير كلمة المرور</button>`;
    formDiv.innerHTML = html;
    modal.style.display = "flex";
    document.getElementById("changePassSubmit").onclick = function() {
      const oldPass = document.getElementById("changePassOld").value;
      const newPass = document.getElementById("changePassNew").value;
      if (!oldPass || !newPass) return statusDiv.textContent = "يرجى إدخال جميع الحقول.";
      db.ref("users/" + currentUser + "/password").once("value").then(snapshot => {
        if (!snapshot.exists() || snapshot.val() !== oldPass) return statusDiv.textContent = "كلمة المرور الحالية غير صحيحة.";
        db.ref("users/" + currentUser + "/password").set(newPass).then(() => {
          statusDiv.textContent = "✅ تم تغيير كلمة المرور بنجاح.";
          logActivity("تغيير كلمة مرور", `تم تغيير كلمة المرور للمستخدم: ${currentUser}`);
          document.getElementById("changePassOld").value = "";
          document.getElementById("changePassNew").value = "";
        });
      });
    };
  }
}
document.getElementById("closeChangePassModal").onclick = function() {
  document.getElementById("changePassModal").style.display = "none";
};

// ========== تحديث ظهور الأزرار حسب الدور ========== 
// تم دمج دالة updateSidebarVisibility في الأعلى مع منطق موحد وتجنب التكرار

// ========== فتح وإغلاق القائمة الجانبية ==========
document.getElementById("sidebarToggleBtn").onclick = () => {
  document.getElementById("sidebarMenu").classList.add("open");
  document.getElementById("sidebarToggleBtn").style.display = "none";
  document.getElementById("sidebarCloseBtn").style.display = "flex";
  // عرض اسم المستخدم أعلى القائمة
  const sidebarUserName = document.getElementById("sidebarUserName");
  sidebarUserName.textContent = currentUser ? "👤 " + currentUser : "غير مسجل";
  updateSidebarVisibility();
};
document.getElementById("sidebarCloseBtn").onclick = () => {
  document.getElementById("sidebarMenu").classList.remove("open");
  document.getElementById("sidebarCloseBtn").style.display = "none";
  document.getElementById("sidebarToggleBtn").style.display = "flex";
  updateSidebarVisibility();
};

// ========== ربط أزرار القائمة الجانبية بأزرار الموقع الأصلية ==========
document.getElementById("sidebarAdminBtn").onclick = () => {
  document.getElementById("sidebarMenu").classList.remove("open");
  document.getElementById("toggleAdminBtn").click();
};
document.getElementById("sidebarEmpStatsBtn").onclick = () => {
  document.getElementById("sidebarMenu").classList.remove("open");
  document.getElementById("toggleEmpStatsBtn").click();
};
document.getElementById("sidebarDeleteDataBtn").onclick = () => {
  document.getElementById("sidebarMenu").classList.remove("open");
  document.getElementById("btnDeleteData").click();
};
document.getElementById("sidebarFeaturesTabBtn").onclick = () => {
  document.getElementById("sidebarMenu").classList.remove("open");
  document.getElementById("btnFeaturesTab").click();
  document.getElementById("featuresTab").style.display = "flex";
  const featuresTabContent = document.getElementById("featuresTabContent");
  featuresTabContent.innerHTML = `
    <div class="feature-section">
      <h4>سجل النشاطات</h4>
      <div id="activityLogBox">جاري التحميل...</div>
    </div>
    <div class="feature-section">
      <h4>معلومات النظام</h4>
      <ul style="margin:0;padding:0 0 0 15px;">
        <li>عدد الموظفين الحالي: <b>${employees.length}</b></li>
        <li>اسم المستخدم الحالي: <b>${currentUser}</b></li>
        <li>الدور: <b>${currentUserRole}</b></li>
      </ul>
    </div>
  `;
  db.ref("activityLog").limitToLast(30).once("value").then(snapshot => {
    const log = snapshot.val() || {};
    let html = `<table class="activity-log-table">
      <tr>
        <th>الوقت</th>
        <th>المستخدم</th>
        <th>النشاط</th>
        <th>الوصف</th>
      </tr>`;
    Object.values(log).reverse().forEach(item => {
      html += `<tr>
        <td>${toEnglishNumbers(item.time || "")}</td>
        <td>${item.user || ""}</td>
        <td>${item.action || ""}</td>
        <td>${item.details || ""}</td>
      </tr>`;
    });
    html += `</table>`;
    document.getElementById("activityLogBox").innerHTML = html;
  });
  // زر إغلاق التبويبة
  const closeBtn = document.getElementById("closeFeaturesTab");
  if (closeBtn) {
    closeBtn.onclick = () => {
      document.getElementById("featuresTab").style.display = "none";
    };
  }
};

// نافذة تحكم صلاحيات سجل النشاطات للمدير
document.getElementById("sidebarUserControlBtn").onclick = function() {
  // إنشاء نافذة منبثقة احترافية
  let modal = document.getElementById("userLogControlModal");
  if (!modal) {
    modal = document.createElement("div");
    modal.id = "userLogControlModal";
    modal.style.position = "fixed";
    modal.style.top = "0";
    modal.style.left = "0";
    modal.style.width = "100vw";
    modal.style.height = "100vh";
    modal.style.background = "rgba(0,0,0,0.35)";
    modal.style.zIndex = "8000";
    modal.style.display = "flex";
    modal.style.alignItems = "center";
    modal.style.justifyContent = "center";
    modal.innerHTML = `
      <div style="background:#fff;max-width:420px;width:95vw;border-radius:14px;box-shadow:0 8px 32px #0002;padding:28px 20px 20px 20px;position:relative;">
        <button id="closeUserLogControlModal" style="position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;">✖</button>
        <h3 style="text-align:center;margin-bottom:18px;color:#009688;">👥 إدارة صلاحيات سجل النشاطات</h3>
        <div id="userLogControlContent" style="min-height:70px;">جاري التحميل...</div>
      </div>
    `;
    document.body.appendChild(modal);
    document.getElementById("closeUserLogControlModal").onclick = function() {
      modal.style.display = "none";
    };
  } else {
    modal.style.display = "flex";
  }

  // تحميل المستخدمين وصلاحياتهم
  db.ref("users").once("value").then(snapshot => {
    const users = snapshot.val() || {};
    let html = `<table style="width:100%;border-collapse:collapse;margin-bottom:10px;">
      <tr>
        <th style="background:#f6f6f6;">المستخدم</th>
        <th style="background:#f6f6f6;">الوصول لسجل النشاطات</th>
        <th style="background:#f6f6f6;">نوع الصلاحية</th>
      </tr>`;
    Object.entries(users).forEach(([username, data]) => {
      if (username === "admin") return; // لا تظهر للمدير نفسه
      html += `<tr>
        <td style="padding:7px 4px;">${username}</td>
        <td style="padding:7px 4px;">
          <label style="display:inline-flex;align-items:center;gap:6px;">
            <input type="checkbox" ${data.canViewLog ? "checked" : ""} onchange="window.setUserLogAccess('${username}', this.checked)">
            <span style="font-size:13px;color:${data.canViewLog ? '#28a745':'#dc3545'};">${data.canViewLog ? 'مفعل':'معطل'}</span>
          </label>
        </td>
        <td style="padding:7px 4px;">
          <select onchange="window.setUserLogType('${username}', this.value)" style="font-size:13px;">
            <option value="all" ${!data.logViewType || data.logViewType==="all" ? "selected" : ""}>كل السجل</option>
            <option value="self" ${data.logViewType==="self" ? "selected" : ""}>سجل المستخدم فقط</option>
          </select>
        </td>
      </tr>`;
    });
    html += `</table>
      <div style="margin-top:10px;font-size:13px;color:#555;">
        عند تفعيل الصلاحية يظهر زر سجل النشاطات للمستخدم في القائمة الجانبية.<br>
        نوع الصلاحية:<br>
        <b>كل السجل:</b> يرى كل النشاطات لجميع المستخدمين.<br>
        <b>سجل المستخدم فقط:</b> يرى فقط نشاطاته هو.<br>
        عند التعطيل يختفي الزر مباشرة من عند المستخدم.
      </div>`;
    document.getElementById("userLogControlContent").innerHTML = html;
    window.setUserLogAccess = function(username, enabled) {
      db.ref("users/" + username + "/canViewLog").set(enabled).then(() => {
        logActivity("تغيير صلاحية سجل النشاطات", `تم ${enabled ? 'تفعيل' : 'تعطيل'} سجل النشاطات للمستخدم: ${username}`);
        updateSidebarVisibility();
      });
    };
    window.setUserLogType = function(username, type) {
      db.ref("users/" + username + "/logViewType").set(type).then(() => {
        logActivity("تغيير نوع صلاحية سجل النشاطات", `تم تغيير نوع الصلاحية للمستخدم: ${username} إلى: ${type === 'all' ? 'كل السجل' : 'سجل المستخدم فقط'}`);
        updateSidebarVisibility();
      });
    };
  });
}
</script>

</body>
</html>
